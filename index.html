<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Release • Into the Void</title>

    <!-- PWA & Mobile Optimization -->
    <meta name="theme-color" content="#050505">
    <meta name="msapplication-navbutton-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Theme Initialization -->
    <script>
        (function () {
            try {
                const theme = localStorage.getItem('release-theme') || 'dark';
                if (theme === 'light') {
                    document.documentElement.classList.add('light-theme');
                    document.documentElement.classList.remove('dark-theme');
                } else {
                    document.documentElement.classList.add('dark-theme');
                    document.documentElement.classList.remove('light-theme');
                }
            } catch (e) {
                console.log("Theme Init Error", e);
            }
        })();
    </script>

    <!-- UI Frameworks & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nexus-orange': 'var(--nexus-orange)',
                        'calm-blue': 'var(--calm-blue)',
                        'bg-deep': 'var(--bg-deep)',
                        'text-light': 'var(--text-light)',
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'border-beam': 'border-beam 10s linear infinite',
                        'border-rotate': 'border-rotate 4s linear infinite',
                    },
                    keyframes: {
                        'border-beam': {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' },
                        },
                        'border-rotate': {
                            'from': { transform: 'rotate(0deg)' },
                            'to': { transform: 'rotate(360deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;600;900&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@100;300;400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="h-screen w-screen selection:bg-orange-500/30">

    <!-- Global Background Elements -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div
            class="absolute top-[10%] left-[50%] -translate-x-1/2 w-[600px] h-[600px] bg-nexus-orange/5 rounded-full blur-[120px]">
        </div>
    </div>

    <!-- Top Bar (Floating Pill) -->
    <header id="nav-bar"
        class="fixed top-4 left-1/2 -translate-x-1/2 z-[150] safe-top pointer-events-none transition-opacity duration-300 w-full px-4 md:px-8">

        <div
            class="glass-card rounded-full px-4 sm:px-6 py-1.5 sm:py-2 flex items-center justify-between gap-4 sm:gap-6 shadow-card-elevated pointer-events-auto border border-white/10 w-full max-w-5xl mx-auto">

            <!-- Logo area -->
            <div class="flex items-center gap-2 cursor-pointer shrink-0" onclick="navigate('home')">
                <div class="w-1.5 h-1.5 bg-nexus-orange rounded-full animate-pulse shadow-[0_0_8px_rgba(255,68,0,0.6)]">
                </div>
                <h1 class="text-[10px] sm:text-xs font-black uppercase tracking-[0.3em] opacity-90">Release</h1>
            </div>

            <!-- Controls (Theme, Fire, Share) & CTA -->
            <div class="flex items-center gap-1 sm:gap-2 shrink-0">
                <button type="button" onclick="toggleGlobalTheme()" aria-label="Toggle Theme" title="Toggle Theme"
                    id="ui-btn-theme"
                    class="w-8 h-8 rounded-full flex items-center justify-center transition-all cursor-pointer opacity-50 hover:opacity-100 hover:bg-white/5 bg-transparent">
                    <i id="theme-icon" class="fa-solid fa-moon text-sm"></i>
                </button>
                <button type="button" onclick="toggleFireAnimation()" aria-label="Toggle Fire Animation"
                    title="Toggle Fire Animation" id="ui-btn-fire"
                    class="w-8 h-8 rounded-full flex items-center justify-center transition-all cursor-pointer opacity-50 hover:opacity-100 hover:bg-white/5 bg-transparent">
                    <i id="fire-toggle-icon" class="fa-solid fa-fire-flame-curved text-xs"></i>
                </button>
                <button type="button" onclick="shareLink()" aria-label="Share" title="Share" id="ui-btn-share"
                    class="w-8 h-8 rounded-full flex items-center justify-center transition-all cursor-pointer opacity-50 hover:opacity-100 hover:bg-white/5 bg-transparent hidden sm:flex">
                    <i class="fa-solid fa-arrow-up-from-bracket text-xs text-light"></i>
                </button>

                <!-- Separator -->
                <div class="w-[1px] h-4 bg-white/20 mx-1 sm:mx-2 hidden sm:block"></div>

                <!-- Action Button -->
                <button type="button" onclick="toggleWaitlist(true)"
                    class="waitlist-radial text-white px-3 sm:px-4 py-1 sm:py-1.5 rounded-full text-[9px] sm:text-[10px] font-black uppercase tracking-[0.2em] hover:scale-105 active:scale-95 transition-all cursor-pointer shadow-[0_2px_10px_rgba(255,68,0,0.3)] hover:shadow-[0_4px_15px_rgba(255,68,0,0.5)] overflow-hidden shiny-button-fix w-20 sm:w-24 shrink-0 border border-white/20 whitespace-nowrap">
                    <div class="marquee-container">
                        <div class="marquee-content">
                            <span>Waitlist • Waitlist • Waitlist • Waitlist • </span>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </header>

    <!-- Main View Switcher -->
    <main class="relative w-full h-full z-10">

        <!-- VIEW: HOME -->
        <section id="view-home" class="view-container active">
            <!-- Hero Background Media (Atmospheric Image) -->
            <div class="hero-bg-media">
                <canvas id="bg-canvas"></canvas>
            </div>

            <div class="scroll-wrapper items-center justify-center px-6 pt-20 sm:pt-24 relative z-10">
                <div class="w-full max-w-2xl text-left my-auto py-12 px-2">
                    <p class="text-[10px] uppercase tracking-[0.5em] text-nexus-orange font-black mb-4">The Void</p>
                    <h1 class="text-[clamp(1.5rem,6vw,3.5rem)] font-thin tracking-tight leading-tight mb-6">Vent <span
                            id="hyper-text-home">anxiety, anger, panic</span> <span id="shiny-tagline-home"
                            class="text-shiny-orange font-black">without judgment.</span>
                    </h1>
                    <p class="text-sm text-text-light/50 font-light leading-relaxed max-w-xl mb-12">Catch the wave
                        before it
                        spills over. Release it all here. A new way to be heard is on the horizon. Join the waitlist to
                        be notified.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 w-full max-w-5xl mx-auto">
                        <!-- Mode 01: Ash It -->
                        <button type="button" onclick="navigate('burn')"
                            class="group relative h-32 white-glass-card rounded-[32px] p-6 text-left transition-all duration-150 hover:scale-[1.02] active:scale-[0.98] hover-glow-orange">
                            <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none">
                                <div class="absolute right-0 top-0 p-8">
                                    <i class="fa-solid fa-fire text-6xl glass-icon-white"></i>
                                </div>
                            </div>
                            <div
                                class="relative z-10 h-full flex flex-col justify-between transition-transform duration-150 group-hover:translate-x-1">
                                <div class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-nexus-orange animate-pulse"></span>
                                    <span class="font-bold uppercase tracking-widest text-[10px] opacity-80">Mode
                                        01</span>
                                </div>
                                <div>
                                    <h3
                                        class="text-xl font-light tracking-tight group-hover:font-normal transition-all">
                                        Ash It</h3>
                                    <p class="text-[9px] uppercase tracking-widest opacity-40 mt-1">Anxiety • Worry •
                                        Thoughts</p>
                                </div>
                            </div>
                        </button>

                        <!-- Mode 02: Calm It -->
                        <button type="button" onclick="navigate('calm')"
                            class="group relative h-32 white-glass-card rounded-[32px] p-6 text-left transition-all duration-150 hover:scale-[1.02] active:scale-[0.98] hover-glow-blue">
                            <!-- Inner clipping container for shine and icons -->
                            <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none">
                                <div
                                    class="absolute right-0 top-0 p-8 opacity-100 group-hover:opacity-100 transition-all duration-200">
                                    <i class="fa-solid fa-wind text-6xl glass-icon-white"></i>
                                </div>
                            </div>
                            <div
                                class="relative z-10 h-full flex flex-col justify-between transition-transform duration-150 group-hover:translate-x-1">
                                <div class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-calm-blue animate-pulse"></span>
                                    <span class="font-bold uppercase tracking-widest text-[10px] text-calm-blue/80">Mode
                                        02</span>
                                </div>
                                <div>
                                    <h3
                                        class="text-xl font-light tracking-tight group-hover:font-normal transition-all">
                                        Air It</h3>
                                    <p class="text-[9px] uppercase tracking-widest opacity-40 mt-1">Breath • Focus •
                                        Peace</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="w-full max-w-5xl py-12 text-center relative z-10 mx-auto mt-auto">
                    <p class="text-[9px] uppercase tracking-[0.4em] text-light opacity-30 font-bold italic mb-2">For
                        relaxing/venting only. Not medical advice.</p>
                    <p class="text-[9px] uppercase tracking-[0.6em] text-light opacity-50 font-black">NO RECORDS • NO
                        ALGORITHMS | Release | A Nexus Project</p>
                </div>
            </div>
        </section>

        <!-- VIEW: ASH -->
        <section id="view-burn" class="view-container">

            <div class="scroll-wrapper items-center pt-24 px-4 md:px-8 pb-6">

                <div class="w-full max-w-5xl flex items-start gap-4 mb-8 relative z-10 px-0 mx-auto">
                    <button onclick="navigate('home')" aria-label="Back"
                        class="mt-1 text-light opacity-20 hover:opacity-100 transition-colors cursor-pointer active:scale-95 relative z-50">
                        <i class="fa-solid fa-chevron-left text-sm"></i>
                    </button>
                    <div>
                        <p class="mt-[9px] text-[10px] uppercase tracking-[0.5em] text-nexus-orange font-black mb-1">
                            Enter the
                            Void</p>
                        <h1 class="text-[clamp(1.1rem,4.5vw,2.2rem)] font-thin tracking-tight leading-tight mb-2">
                            A sanctuary <span id="hyper-text-burn">for your</span> <span id="shiny-tagline-burn"
                                class="text-shiny-orange font-black">CALM IS COMING...</span>
                        </h1>
                        <p class="text-xs md:text-sm text-text-light/50 font-light leading-relaxed max-w-xl">Release the
                            weight
                            before it breaks you. No judgment. No records. Just release.</p>
                    </div>
                </div>

                <div class="flex-0 w-full flex flex-col items-center justify-center p-0 relative z-20">

                    <!-- Editor Controls (Anchored to Top-Right of Card) -->


                    <div id="editor-card"
                        class="relative w-full max-w-5xl h-[45vh] md:h-[55vh] glass-card rounded-[40px] flex items-center justify-center p-6 transition-all duration-500 group/editor shadow-card-elevated overflow-hidden border-white/5 z-50">

                        <!-- Editor Controls (Relocated to bottom toolbar) -->

                        <textarea id="burn-area" autofocus
                            class="relative z-10 w-full h-full text-left text-xl md:text-3xl font-light bg-transparent border-none outline-none resize-none placeholder-text-light/10 leading-relaxed transition-opacity duration-300 pb-20"
                            placeholder="Ash whatever's weighing you down"></textarea>

                        <!-- Unified Editor Toolbar (Inside Card) -->
                        <div
                            class="absolute bottom-0 left-0 w-full p-4 md:p-6 flex justify-between items-end z-[70] pointer-events-none">
                            <!-- Left: Editor Tools (Voice, Font, Theme, Mobile Menu) -->
                            <div class="flex items-center gap-2 pointer-events-auto">
                                <!-- Voice Toggle -->
                                <button id="ui-btn-mode" onclick="toggleMode()" aria-label="Toggle Voice Mode"
                                    class="h-10 px-4 flex items-center justify-center gap-2 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black uppercase tracking-[0.1em] opacity-70 hover:opacity-100 transition-all cursor-pointer shadow-[0_2px_8px_rgba(255,68,0,0.1)] hover:shadow-[0_4px_12px_rgba(255,68,0,0.2)]">
                                    <i class="fa-solid fa-microphone"></i>
                                    <span class="hidden sm:inline">Voice</span>
                                </button>

                                <!-- Mobile 3-Dots Menu Toggle -->
                                <button id="btn-mobile-menu" onclick="toggleEditorMenu()"
                                    class="md:hidden flex items-center justify-center bg-white/5 rounded-full w-10 h-10 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                                    <i class="fa-solid fa-ellipsis-vertical text-xs text-white/50"></i>
                                </button>

                                <!-- Desktop/Expanded Controls -->
                                <div id="editor-controls-group"
                                    class="hidden md:flex flex-col md:flex-row items-start md:items-center gap-2 transition-opacity duration-300 opacity-0 md:opacity-100 absolute bottom-16 left-4 md:static md:bottom-auto md:left-auto bg-black/40 md:bg-transparent backdrop-blur-md md:backdrop-blur-none p-3 md:p-0 rounded-2xl md:rounded-none border border-white/10 md:border-none">
                                    <!-- Font Family Control -->
                                    <div id="ctrl-family-container" onclick="toggleControl('ctrl-family')"
                                        onmouseleave="toggleControl(null)"
                                        class="editor-control flex items-center bg-white/5 rounded-full px-3.5 h-10 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                                        <i id="ui-icon-family"
                                            class="fa-solid fa-pen-nib text-xs text-white/50 hover:text-white/80 transition-colors"></i>
                                        <div id="ctrl-family"
                                            class="w-0 overflow-hidden transition-all duration-500 ease-out flex items-center gap-2 pl-0">
                                            <button onclick="changeFontFamily(0); event.stopPropagation()"
                                                class="text-[10px] font-sans font-bold opacity-60 hover:opacity-100 hover:scale-110 transition-all uppercase">Sans</button>
                                            <button onclick="changeFontFamily(1); event.stopPropagation()"
                                                class="text-[10px] font-serif font-bold opacity-60 hover:opacity-100 hover:scale-110 transition-all uppercase">Serif</button>
                                            <button onclick="changeFontFamily(2); event.stopPropagation()"
                                                class="text-[10px] font-mono font-bold opacity-60 hover:opacity-100 hover:scale-110 transition-all uppercase">Mono</button>
                                        </div>
                                    </div>

                                    <!-- Font Size Control -->
                                    <div id="ctrl-font-container" onclick="toggleControl('ctrl-font')"
                                        onmouseleave="toggleControl(null)"
                                        class="editor-control flex items-center bg-white/5 rounded-full px-3.5 h-10 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                                        <i id="ui-icon-font"
                                            class="fa-solid fa-font text-xs text-white/50 hover:text-white/80 transition-colors"></i>
                                        <div id="ctrl-font"
                                            class="w-0 overflow-hidden transition-all duration-500 ease-out flex items-center">
                                            <input type="range" min="0" max="3" value="1" step="1"
                                                oninput="changeTextSize(this.value)" onclick="event.stopPropagation()"
                                                aria-label="Text Size"
                                                class="w-24 h-1 ml-4 bg-white/10 rounded-lg appearance-none cursor-pointer accent-nexus-orange">
                                        </div>
                                    </div>

                                    <!-- Theme Control -->
                                    <div id="ctrl-theme-container" onclick="toggleControl('ctrl-theme')"
                                        onmouseleave="toggleControl(null)"
                                        class="editor-control flex items-center bg-white/5 rounded-full px-3.5 h-10 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                                        <i id="ui-icon-theme"
                                            class="fa-solid fa-palette text-xs text-white/50 hover:text-white/80 transition-colors"></i>
                                        <div id="ctrl-theme"
                                            class="w-0 overflow-hidden transition-all duration-500 ease-out flex items-center gap-2 pl-0">
                                            <button onclick="changeThemeColor(0); event.stopPropagation()"
                                                class="w-4 h-4 rounded-full bg-[var(--bg-deep)] border border-white/20 hover:scale-125 transition-transform"
                                                title="Void"></button>
                                            <button onclick="changeThemeColor(1); event.stopPropagation()"
                                                class="w-4 h-4 rounded-full bg-[#fff3e0] border border-white/10 hover:scale-125 transition-transform"
                                                title="Ivory"></button>
                                            <button onclick="changeThemeColor(2); event.stopPropagation()"
                                                class="w-4 h-4 rounded-full bg-[#e5f3f8] border border-white/10 hover:scale-125 transition-transform"
                                                title="Mist"></button>
                                            <button onclick="changeThemeColor(3); event.stopPropagation()"
                                                class="w-4 h-4 rounded-full bg-[#dadecf] border border-white/10 hover:scale-125 transition-transform"
                                                title="Pewter"></button>
                                            <button onclick="changeThemeColor(4); event.stopPropagation()"
                                                class="w-4 h-4 rounded-full bg-[#191738] border border-white/10 hover:scale-125 transition-transform"
                                                title="Midnight"></button>
                                        </div>
                                    </div>

                                    <!-- Mobile Haptic Toggle -->
                                    <div id="ctrl-haptic-mobile" onclick="toggleHaptics()"
                                        class="editor-control flex md:hidden items-center bg-white/5 rounded-full px-3.5 h-10 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                                        <i class="fa-solid fa-vibration text-xs text-white/50"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Primary Action (Ash It) -->
                            <div class="pointer-events-auto">
                                <button type="button" onclick="handleMainAction()" id="btn-main-action"
                                    class="h-10 px-6 sm:px-8 rounded-full uppercase tracking-[0.2em] text-[10px] sm:text-xs font-bold active:scale-95 transition-all bg-white/10 text-white hover:bg-white/20 flex items-center justify-center border border-white/20 shadow-lg backdrop-blur-md">
                                    <span>Ash It</span>
                                    <i class="fa-solid fa-fire ml-2 opacity-50"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Audio Recorder Interface -->
                        <div id="audio-wrapper"
                            class="absolute inset-0 z-20 flex flex-col items-center justify-center p-8 hidden pointer-events-none opacity-0 transition-opacity duration-300">
                            <canvas id="audio-visualizer" class="w-full h-32 mb-8 opacity-80"></canvas>

                            <div class="flex items-center justify-center pointer-events-auto relative">
                                <!-- Playback (Hidden initially) -->
                                <button id="btn-play-audio" onclick="togglePlayback()" aria-label="Play Recording"
                                    class="hidden w-20 h-20 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all relative z-20 cursor-pointer border border-white/10">
                                    <i class="fa-solid fa-play text-white text-2xl translate-x-1"></i>
                                </button>
                            </div>

                            <div class="flex flex-col items-center mt-6 gap-2">
                                <p id="audio-timer" class="text-4xl font-mono text-white/50 font-light tracking-widest">
                                    00:00</p>
                                <p id="audio-status" class="text-[10px] uppercase tracking-[0.3em] opacity-40">Tap to
                                    Record
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Removed external #burn-action to consolidate buttons inside #editor-card -->

                <!-- Marketing Card (Hidden) -->
                <div id="burn-marketing"
                    class="hidden w-full max-w-5xl pt-0 mt-8 md:mt-12 mx-auto animate-fly-top relative z-10 px-0">
                    <div
                        class="white-glass-card rounded-[40px] p-4 text-center space-y-4 relative overflow-hidden border-none">
                        <!-- Card Background Image -->
                        <div class="absolute inset-0 z-0 pointer-events-none opacity-[0.28]">
                            <img src="index/waitlist.webp" alt="" class="w-full h-full object-cover" loading="lazy">
                        </div>
                        <div class="relative z-10 space-y-4 p-4">
                            <p class="text-sm opacity-80 font-light leading-relaxed">That thought is gone. If the weight
                                remains, a Nexus Sentinel is listening.</p>
                            <div class="relative w-full max-w-2xl mx-auto group/pill animate-fade">
                                <!-- Perimeter Beam Border Mask -->
                                <div class="relative p-[1px] rounded-full overflow-hidden shadow-2xl">
                                    <!-- Rotating Beam -->
                                    <div id="marketing-beam"
                                        class="absolute inset-[-150%] animate-border-rotate opacity-80"
                                        style="background: conic-gradient(from 0deg, transparent 0%, #ff6633 10%, transparent 20%);">
                                    </div>

                                    <!-- Inner Content -->
                                    <div id="marketing-pill-inner"
                                        class="bg-white rounded-[28px] sm:rounded-full p-1.5 flex flex-col sm:flex-row items-stretch sm:items-center relative z-10 border border-white/5 gap-2 sm:gap-0">
                                        <input type="email" id="waitlist-email-inline" placeholder="Enter your email"
                                            class="flex-1 bg-transparent px-4 sm:px-6 md:px-8 py-3 sm:py-3.5 text-sm font-light tracking-wide focus:outline-none text-black placeholder:text-black/40 border-none outline-none text-center sm:text-left">
                                        <button type="button" onclick="submitInlineWaitlist()"
                                            class="group/waitlist-btn bg-black text-white px-6 sm:px-8 py-3 sm:py-3.5 rounded-full text-sm sm:text-base transition-all hover:bg-zinc-900 active:scale-[0.97] flex items-center justify-center gap-0 hover:gap-2 sm:hover:gap-3">
                                            <span class="whitespace-nowrap">Join Waitlist</span>
                                            <i
                                                class="fa-solid fa-arrow-right opacity-0 w-0 group-hover/waitlist-btn:opacity-100 group-hover/waitlist-btn:w-auto transition-all duration-300 text-xs hidden sm:inline-block"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div id="ash-footer" class="w-full max-w-5xl py-12 text-center relative z-10 mx-auto">
                    <p id="ui-text-footer"
                        class="text-[9px] uppercase tracking-[0.4em] text-light opacity-30 font-bold italic mb-2">
                        For
                        relaxing/venting only. Not medical advice.</p>
                    <p class="text-[9px] uppercase tracking-[0.6em] text-light opacity-50 font-black">NO RECORDS •
                        NO
                        ALGORITHMS | Release | A Nexus Project</p>
                </div>
            </div>
            </div>
        </section>

        <!-- VIEW: SMASH -->
        <section id="view-smash" class="view-container" onclick="triggerHammer(event)">

            <div class="scroll-wrapper items-center justify-center bg-transparent overflow-hidden">
                <div id="smash-overlay"
                    class="absolute inset-0 z-10 pointer-events-none transition-opacity duration-300">
                </div>

                <div class="relative z-0 text-center pointer-events-none">
                    <h3 class="text-sm font-thin tracking-[1em] opacity-20 uppercase">Surface</h3>
                    <p id="smash-hint" class="text-[9px] uppercase tracking-widest opacity-10 mt-2">Tap repeatedly to
                        release energy</p>
                </div>

                <!-- Marketing Card (Hidden) -->
                <div id="smash-marketing"
                    class="hidden absolute inset-0 z-30 bg-black/90 backdrop-blur-2xl flex flex-col items-center justify-center p-8 text-center">
                    <button type="button" onclick="toggleWaitlist(true)"
                        class="bg-white text-black px-10 py-4 rounded-full font-black uppercase text-[10px] tracking-[0.2em]">Join
                        Waitlist</button>
                    <button type="button" onclick="resetMode('smash')"
                        class="text-nexus-orange text-[10px] font-black uppercase tracking-[0.2em]">Repair
                        Screen</button>
                </div>
                <div class="w-full max-w-5xl py-12 text-center relative z-10 mx-auto">
                    <p class="text-[9px] uppercase tracking-[0.4em] text-light opacity-30 font-bold italic mb-2">For
                        relaxing/venting only. Not medical advice.</p>
                    <p class="text-[9px] uppercase tracking-[0.6em] text-light opacity-50 font-black">NO RECORDS • NO
                        ALGORITHMS | Release | A Nexus Project</p>
                </div>
            </div>
        </section>

        <section id="view-calm" class="view-container">
            <div class="scroll-wrapper items-center pt-24 px-4 md:px-8 pb-6 text-black">
                <!-- Main Breathing Area -->
                <div class="w-full flex flex-col items-center relative z-10">
                    <div class="relative w-64 h-64 sm:w-80 sm:h-80 flex items-center justify-center">
                        <!-- Dynamic Physics Visualizer -->
                        <canvas id="calm-visualizer"
                            class="absolute inset-0 w-full h-full pointer-events-none"></canvas>

                        <!-- Core Text/Timer -->
                        <div class="relative z-10 flex flex-col items-center">
                            <span id="calm-timer-countdown"
                                class="text-6xl font-thin tracking-tighter mb-2 select-none text-black/80"></span>
                            <span id="breathing-txt"
                                class="text-[11px] font-black uppercase tracking-[0.5em] pl-[0.5em] text-calm-blue transition-all duration-1000 select-none">Inhale</span>
                        </div>
                    </div>
                </div>

                <!-- Presets Selector -->
                <div class="w-full max-w-lg mb-8 relative z-20">
                    <div class="flex items-center justify-center overflow-x-auto gap-6 py-4 no-scrollbar px-2 snap-x"
                        id="calm-presets-list">
                        <!-- Presets will be injected here via JS -->
                    </div>
                </div>

                <!-- Controls Panel (White Glassmorphism) -->
                <div
                    class="w-full max-w-lg white-glass-card rounded-[32px] p-5 mb-8 relative z-20 flex flex-col gap-4 shadow-2xl">
                    <!-- Technique Name Header -->
                    <div class="flex flex-col items-center gap-0 border-b border-black/5 pb-2">
                        <h3 id="active-technique-name" class="text-lg font-light tracking-tight text-black/70">Box
                            Breathing</h3>
                    </div>

                    <!-- Play/Pause & Actions -->
                    <div class="flex items-center justify-between">
                        <button onclick="toggleCalmPause()" id="btn-calm-pause" title="Play/Pause"
                            class="w-12 h-12 rounded-full bg-black/5 hover:bg-black/10 flex items-center justify-center transition-all border border-black/5">
                            <i class="fa-solid fa-pause text-black/60 text-sm"></i>
                        </button>
                        <div class="flex-1 px-4">
                            <button type="button" onclick="finishCalm()"
                                class="w-full h-12 rounded-2xl bg-calm-blue/10 text-calm-blue border border-calm-blue/20 font-black uppercase tracking-[0.2em] text-[10px] hover:bg-calm-blue/20 transition-all">
                                I feel grounded
                            </button>
                        </div>
                    </div>

                    <!-- Param Adjustments -->
                    <div class="grid grid-cols-4 gap-2 sm:gap-4 text-black/60 border-t border-black/5 pt-4">
                        <div class="flex flex-col items-center gap-1 sm:gap-2">
                            <p
                                class="text-[7px] sm:text-[8px] uppercase tracking-wider sm:tracking-widest font-black opacity-30">
                                Inhale</p>
                            <span id="display-inhale" class="text-base sm:text-lg font-light">4</span>
                        </div>
                        <div class="flex flex-col items-center gap-1 sm:gap-2 border-l border-black/5">
                            <p
                                class="text-[7px] sm:text-[8px] uppercase tracking-wider sm:tracking-widest font-black opacity-30">
                                Hold</p>
                            <span id="display-hold" class="text-base sm:text-lg font-light">4</span>
                        </div>
                        <div class="flex flex-col items-center gap-1 sm:gap-2 border-l border-black/5">
                            <p
                                class="text-[7px] sm:text-[8px] uppercase tracking-wider sm:tracking-widest font-black opacity-30">
                                Exhale</p>
                            <span id="display-exhale" class="text-base sm:text-lg font-light">4</span>
                        </div>
                        <div class="flex flex-col items-center gap-1 sm:gap-2 border-l border-black/5">
                            <p
                                class="text-[7px] sm:text-[8px] uppercase tracking-wider sm:tracking-widest font-black opacity-30">
                                Rest</p>
                            <span id="display-rest" class="text-base sm:text-lg font-light">4</span>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="w-full max-w-md py-8 text-center relative z-10 mx-auto opacity-30">
                    <p class="text-[9px] uppercase tracking-[0.4em] text-black font-bold italic">Breath is the bridge
                        which connects life to consciousness.</p>
                </div>

                <!-- Marketing Card (Hidden) -->
                <div id="calm-marketing"
                    class="hidden absolute inset-0 z-50 bg-white/95 backdrop-blur-2xl flex flex-col items-center justify-center p-8 text-center">
                    <div class="max-w-xs space-y-12 animate-slide">
                        <p class="text-3xl font-thin italic text-calm-blue leading-tight">Hold onto this <span
                                class="font-bold underline underline-offset-8">peace.</span></p>
                        <div class="space-y-4">
                            <p class="text-[10px] tracking-widest uppercase opacity-40 font-black">Find deep connection
                                on Nexus.</p>
                            <button type="button" onclick="toggleWaitlist(true)"
                                class="text-nexus-orange text-[10px] font-black uppercase tracking-[0.2em] underline underline-offset-8">Join
                                Nexus Waitlist</button>
                        </div>
                        <button type="button" onclick="navigate('home')"
                            class="text-[9px] uppercase tracking-widest opacity-40 hover:opacity-100 font-bold border-b border-black/10 pb-1">Back
                            to the void</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Marketing Card (Hidden) -->
        <div id="calm-marketing"
            class="hidden absolute inset-0 z-50 bg-white/95 backdrop-blur-2xl flex flex-col items-center justify-center p-8 text-center">
            <div class="max-w-xs space-y-12 animate-slide">
                <p class="text-3xl font-thin italic text-calm-blue leading-tight">Hold onto this <span
                        class="font-bold underline underline-offset-8">peace.</span></p>
                <div class="space-y-4">
                    <p class="text-[10px] tracking-widest uppercase opacity-40 font-black">Find deep connection
                        on Nexus.</p>
                    <button type="button" onclick="toggleWaitlist(true)"
                        class="text-nexus-orange text-[10px] font-black uppercase tracking-[0.2em] underline underline-offset-8">Join
                        Nexus Waitlist</button>
                </div>
                <button type="button" onclick="navigate('home')"
                    class="text-[9px] uppercase tracking-widest opacity-40 hover:opacity-100 font-bold border-b border-black/10 pb-1">Back
                    to the void</button>
            </div>
        </div>
        </div>
        </section>

    </main>

    <!-- Global Feedback Button -->
    <button onclick="toggleFeedbackModal(true)" id="btn-global-feedback"
        class="fixed bottom-6 right-6 z-[100] w-12 h-12 rounded-full glass-card border border-white/10 flex items-center justify-center text-white/50 hover:text-white/90 hover:bg-white/10 hover:scale-110 active:scale-95 transition-all shadow-card-elevated backdrop-blur-md cursor-pointer group/feedback"
        aria-label="Give Feedback" title="Give Feedback">
        <i class="fa-regular fa-comment text-lg"></i>
        <!-- Tooltip -->
        <span
            class="absolute right-[120%] mr-3 whitespace-nowrap bg-black/80 text-white text-[10px] uppercase tracking-wider font-bold py-1.5 px-3 rounded-lg opacity-0 group-hover/feedback:opacity-100 transition-opacity pointer-events-none hidden md:block border border-white/10">Feedback</span>
    </button>

    <!-- Feedback Modal -->
    <div id="feedback-modal"
        class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto"
            onclick="toggleFeedbackModal(false)"></div>

        <!-- Modal Content -->
        <div class="relative z-10 w-[90%] max-w-md mx-auto glass-card rounded-[32px] border border-white/10 p-6 md:p-8 transform scale-95 opacity-0 transition-all duration-300 shadow-2xl overflow-hidden pointer-events-auto"
            id="feedback-modal-content">

            <div class="flex justify-between items-start mb-6 pt-2">
                <div>
                    <h2 class="text-xl md:text-2xl font-light tracking-tight text-white mb-1">Your Voice</h2>
                    <p class="text-[9px] text-white/40 uppercase tracking-widest font-bold">Help shape the Void</p>
                </div>
                <button onclick="toggleFeedbackModal(false)"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition-colors text-white/40 hover:text-white cursor-pointer">
                    <i class="fa-solid fa-times text-xs"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Ash It Rating (Dark Mode Style) -->
                <div
                    class="group relative white-glass-card white-glass-card-dark rounded-[32px] p-6 text-left transition-all duration-300 hover-glow-orange flex flex-col gap-3 overflow-hidden">
                    <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none z-0">
                        <div
                            class="absolute right-0 top-0 p-4 sm:p-6 opacity-30 group-hover:opacity-60 transition-all duration-300 group-hover:scale-110">
                            <i class="fa-solid fa-fire text-5xl sm:text-6xl glass-icon-white"></i>
                        </div>
                    </div>
                    <div class="relative z-10 flex flex-col gap-3">
                        <label
                            class="text-[10px] uppercase tracking-[0.2em] font-bold text-nexus-orange opacity-90 drop-shadow-md">
                            Rate "Ash It" Experience
                        </label>
                        <div class="flex gap-2" id="rating-ash">
                            <i class="fa-solid fa-star text-white/20 hover:text-nexus-orange/80 cursor-pointer transition-colors text-2xl drop-shadow-sm"
                                data-value="1" onclick="setRating('ash', 1)"></i>
                            <i class="fa-solid fa-star text-white/20 hover:text-nexus-orange/80 cursor-pointer transition-colors text-2xl drop-shadow-sm"
                                data-value="2" onclick="setRating('ash', 2)"></i>
                            <i class="fa-solid fa-star text-white/20 hover:text-nexus-orange/80 cursor-pointer transition-colors text-2xl drop-shadow-sm"
                                data-value="3" onclick="setRating('ash', 3)"></i>
                            <i class="fa-solid fa-star text-white/20 hover:text-nexus-orange/80 cursor-pointer transition-colors text-2xl drop-shadow-sm"
                                data-value="4" onclick="setRating('ash', 4)"></i>
                            <i class="fa-solid fa-star text-white/20 hover:text-nexus-orange/80 cursor-pointer transition-colors text-2xl drop-shadow-sm"
                                data-value="5" onclick="setRating('ash', 5)"></i>
                        </div>
                    </div>
                </div>

                <!-- Air It Rating (Light Mode Style) -->
                <div
                    class="group relative white-glass-card white-glass-card-light rounded-[32px] p-6 text-left transition-all duration-300 hover-glow-blue flex flex-col gap-3 overflow-hidden">
                    <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none z-0">
                        <div
                            class="absolute right-0 top-0 p-4 sm:p-6 opacity-10 group-hover:opacity-30 transition-all duration-300 group-hover:scale-110 -translate-y-2">
                            <i class="fa-solid fa-wind text-5xl sm:text-6xl text-black"></i>
                        </div>
                    </div>
                    <div class="relative z-10 flex flex-col gap-3">
                        <label
                            class="text-[10px] uppercase tracking-[0.2em] font-bold text-calm-blue opacity-90 drop-shadow-sm">
                            Rate "Air It" Experience
                        </label>
                        <div class="flex gap-2" id="rating-air">
                            <i class="fa-solid fa-star text-black/10 hover:text-calm-blue cursor-pointer transition-colors text-2xl"
                                data-value="1" onclick="setRating('air', 1)"></i>
                            <i class="fa-solid fa-star text-black/10 hover:text-calm-blue cursor-pointer transition-colors text-2xl"
                                data-value="2" onclick="setRating('air', 2)"></i>
                            <i class="fa-solid fa-star text-black/10 hover:text-calm-blue cursor-pointer transition-colors text-2xl"
                                data-value="3" onclick="setRating('air', 3)"></i>
                            <i class="fa-solid fa-star text-black/10 hover:text-calm-blue cursor-pointer transition-colors text-2xl"
                                data-value="4" onclick="setRating('air', 4)"></i>
                            <i class="fa-solid fa-star text-black/10 hover:text-calm-blue cursor-pointer transition-colors text-2xl"
                                data-value="5" onclick="setRating('air', 5)"></i>
                        </div>
                    </div>
                </div>

                <!-- General Feedback -->
                <div class="flex flex-col gap-3">
                    <label class="text-[10px] uppercase tracking-[0.2em] font-bold text-white/50">Any other
                        thoughts?</label>
                    <textarea id="feedback-text" rows="3" placeholder="Tell us what you love, hate, or wish existed..."
                        class="w-full bg-black/20 border border-white/5 rounded-2xl p-4 text-sm font-light text-white placeholder-white/20 focus:outline-none focus:border-white/20 resize-none transition-colors"></textarea>
                </div>

                <!-- Submit Action -->
                <button onclick="submitFeedback()" id="btn-submit-feedback"
                    class="w-full h-12 rounded-[16px] bg-white/10 hover:bg-white/20 text-white text-[10px] uppercase tracking-[0.2em] font-bold transition-all border border-white/10 mt-2 shadow-[0_4px_20px_rgba(255,255,255,0.05)] cursor-pointer">
                    Send Feedback
                </button>
                <div id="feedback-success-msg"
                    class="h-[80px] flex flex-col items-center justify-center gap-3 opacity-0 transition-opacity hidden mt-2">
                    <div class="text-xs text-nexus-orange font-bold uppercase tracking-widest"><i
                            class="fa-solid fa-check mr-2"></i> Received. Thank you.</div>
                    <button onclick="toggleFeedbackModal(false); toggleWaitlist(true);"
                        class="text-[10px] uppercase tracking-[0.2em] font-normal text-white/50 hover:text-white transition-colors border-b border-white/20 hover:border-white pb-1">
                        Join the Waitlist
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Overlays -->
    <canvas id="burn-canvas" class="fixed inset-0 pointer-events-none z-[999999]"></canvas>

    <!-- WebGL Shaders for Burning Effect -->
    <script id="vs-burn" type="x-shader/x-vertex">
        attribute vec2 position;
        varying vec2 vUv;
        void main() {
            vUv = (position + 1.0) / 2.0;
            vUv.y = 1.0 - vUv.y;
            gl_Position = vec4(position, 0.0, 1.0);
        }
    </script>

    <script id="fs-burn" type="x-shader/x-fragment">
        precision highp float;
        uniform sampler2D uTexture;
        uniform float uTime;
        uniform float uProgress;
        uniform float uSeed;
        uniform float uIntensity;
        uniform vec2 uCardSize;
        uniform vec2 uCardPos;
        uniform vec2 uResolution;
        uniform float uDpr;
        varying vec2 vUv;

        float hash(vec2 p) {
            vec3 p3  = fract(vec3(p.xyx) * 0.1031);
            p3 += dot(p3, p3.yzx + 33.33);
            return fract((p3.x + p3.y) * p3.z);
        }

        float noise(vec2 p) {
            vec2 i = floor(p);
            vec2 f = fract(p);
            f = f * f * (3.0 - 2.0 * f);
            float a = hash(i);
            float b = hash(i + vec2(1.0, 0.0));
            float c = hash(i + vec2(0.0, 1.0));
            float d = hash(i + vec2(1.0, 1.0));
            return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);
        }

        float fbm(vec2 p) {
            float v = 0.0;
            float a = 0.5;
            vec2 shift = vec2(100.0);
            for (int i = 0; i < 5; i++) {
                v += a * noise(p);
                p = p * 2.0 + shift;
                a *= 0.5;
            }
            return v;
        }

        float sdRoundedBox(vec2 p, vec2 b, float r) {
            vec2 q = abs(p) - b + r;
            return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r;
        }

        void main() {
            vec2 uv = gl_FragCoord.xy / uResolution;
            float pixelX = gl_FragCoord.x;
            float pixelY = uResolution.y - gl_FragCoord.y;
            vec2 noiseUv = uv * vec2(uResolution.x / uResolution.y, 1.0);

            // Original Fire Noise (Max Detail / High Frequency)
            float n = fbm(noiseUv * 5.0 - vec2(0.0, uTime * 0.8));
            float n2 = fbm(noiseUv * 10.0 - vec2(0.0, uTime * 2.0));
            
            // Multi-layered Atmospheric flames (Bottom) - Shrinks and dims slowly
            float vShift = 0.10 + (1.0 - uIntensity) * 0.05; 
            float fireBase = smoothstep(0.35 * uIntensity, 0.05 * uIntensity, uv.y + vShift + (n2 - 0.5) * 0.2 * uIntensity);
            float fireCore = smoothstep(0.2 * uIntensity, 0.0, uv.y + vShift + (n2 - 0.5) * 0.12 * uIntensity);
            float fireWhiteCore = smoothstep(0.1 * uIntensity, 0.0, uv.y + vShift + (n2 - 0.5) * 0.08 * uIntensity);
            
            // Contrast-Adaptive Fire Palette (Vibrant in both modes)
            vec3 fireRed = vec3(1.0, 0.0, 0.0);
            vec3 fireOrange = vec3(1.0, 0.3, 0.0);
            vec3 fireYellow = vec3(1.0, 0.75, 0.0); // Deep Gold/Yellow
            vec3 fireWhite = vec3(1.0, 0.9, 0.5);  // Peach/White (Warm)
            
            // Adjust fire colors slightly for light mode if atmospheric intensity is low
            if (uIntensity < 0.1) {
                fireRed = vec3(1.0, 0.1, 0.1);
                fireOrange = vec3(1.0, 0.4, 0.0);
            }
            
            vec3 atmosColor = mix(fireRed, fireOrange, fireBase);
            atmosColor = mix(atmosColor, fireYellow, fireCore);
            atmosColor = mix(atmosColor, fireWhite, fireWhiteCore * 0.3); // Very little white
            
            // Intensity calculation - Consistently diminished based on uIntensity
            float atmosIntensity = clamp(fireBase * 1.5 + fireCore * 0.5 + fireWhiteCore * 0.3, 0.0, 1.0) * uIntensity;

            // Base Atmosphere (The static tips at the bottom - NOT affected by uProgress)
            vec4 colorAtmosBase = vec4(atmosColor, atmosIntensity);

            // Rounded Card Masking (40px radius)
            vec2 p = vec2(pixelX, pixelY) - uCardPos;
            vec2 b = uCardSize / 2.0;
            float d = sdRoundedBox(p, b, 40.0 * uDpr);
            bool insideCard = d <= 0.0;
            
            if (insideCard) {
                vec2 textureUv = (p + b) / uCardSize;
                vec4 texColor = texture2D(uTexture, textureUv);
                
                // Randomized Card Burn (Synced with Gallery logic)
                float cardNoise = fbm(textureUv * 6.0 + uSeed); 
                float burnThreshold = uProgress * 1.5;
                
                // Use multiple threshold levels for Red -> Orange -> Yellow
                float edgeRed = smoothstep(burnThreshold - 0.25, burnThreshold - 0.1, 1.0 - cardNoise);
                float edgeOrange = smoothstep(burnThreshold - 0.15, burnThreshold - 0.05, 1.0 - cardNoise);
                float edgeYellow = smoothstep(burnThreshold - 0.05, burnThreshold, 1.0 - cardNoise);
                
                if (1.0 - cardNoise < burnThreshold) {
                    // Constant Card Intensity (0.9 as per user request)
                    float cardIntensity = 0.9;

                    // Fire colors for the card burn - Multi-layered Vibrant Mix
                    vec3 burnFireColor = mix(fireRed, fireOrange, edgeOrange);
                    burnFireColor = mix(burnFireColor, fireYellow, edgeYellow);
                    burnFireColor = mix(burnFireColor, fireWhite, smoothstep(0.9, 1.0, edgeYellow) * 0.4);
                    
                    // Higher Alpha for Light Mode readability
                    float alphaBoost = (uIntensity < 0.1) ? 1.5 : 1.0;
                    float finalAlpha = clamp(atmosIntensity + edgeRed * cardIntensity * alphaBoost, 0.0, 1.0);

                    // Embers at the randomized edge
                    float emberEdge = smoothstep(burnThreshold - 0.1, burnThreshold, 1.0 - cardNoise) - edgeYellow;
                    vec3 emberColor = vec3(1.5, 0.4, 0.1) * emberEdge * cardIntensity;

                    // Boost saturation for Light Mode
                    vec3 finalFireCol = (burnFireColor * (1.2 + edgeYellow * 0.6) + emberColor * 2.0);
                    if (uIntensity < 0.1) finalFireCol *= 1.2;

                    gl_FragColor = vec4(finalFireCol * cardIntensity, finalAlpha);
                } else {
                    gl_FragColor = texColor;
                }
            } else {
                // Background stays as the static atmosphere (only the tips)
                gl_FragColor = colorAtmosBase;
            }
        }
    </script>



    <!-- Waitlist Modal -->
    <div id="waitlist-modal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/20 backdrop-blur-3xl">
        <!-- Card Container -->
        <div class="w-full max-w-lg white-glass-card rounded-[32px] relative shadow-2xl group">
            <!-- Inner Content Wrapper (for clipping shine/blobs without clipping border) -->
            <div class="relative w-full h-full p-12 overflow-hidden rounded-[32px]">

                <!-- Keep existing blob or remove? User wants Ash It style. Ash It has specific icon. I'll keep the blob as it fits the modal content better than a fire icon. -->
                <div class="absolute -top-20 -right-20 w-40 h-40 bg-nexus-orange/10 blur-3xl rounded-full"></div>

                <button type="button" onclick="toggleWaitlist(false)" aria-label="Close"
                    class="absolute top-8 right-8 w-10 h-10 flex items-center justify-center rounded-full bg-white/5 border border-white/10 text-2xl opacity-40 hover:opacity-100 hover:bg-white/10 transition-all cursor-pointer z-50">
                    <i class="fa-solid fa-xmark text-sm"></i>
                </button>

                <div class="relative z-10 text-center">
                    <h4 class="text-4xl font-thin tracking-tighter uppercase mb-2">The <span
                            class="text-nexus-orange font-bold">Nexus</span></h4>
                    <p class="text-[10px] uppercase tracking-[0.5em] text-nexus-orange font-black mb-8">The Future of
                        Empathy</p>

                    <div class="space-y-6 mb-12">
                        <p class="text-base text-white/80 font-light leading-relaxed px-4">
                            Welcome to the <span class="text-nexus-orange font-normal">Nexus</span>, the future of
                            empathy.
                            Venting is temporary, being heard is healing.
                        </p>
                        <p class="text-sm text-white/50 font-light leading-relaxed px-6">
                            Nexus is building a judgment-free zone where anonymity meets deep understanding. No records,
                            no
                            algorithms, just real humans ready to listen when the weight gets too heavy or you just want
                            to
                            be heard.
                        </p>
                    </div>

                    <form action="https://formspree.io/f/YOUR_FORM_ID_HERE" method="POST" class="space-y-4">
                        <input type="email" name="email" required placeholder="name@email.com"
                            class="w-full bg-white/[0.03] border border-white/30 rounded-2xl p-5 text-sm outline-none focus:border-nexus-orange transition-all placeholder:opacity-60">
                        <button type="submit" onclick="track('Waitlist Joined')"
                            class="w-full bg-nexus-orange text-white h-14 rounded-2xl uppercase tracking-[0.4em] text-[14px] shadow-2xl shadow-nexus-orange/30">
                            Join Waitlist
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- AUDIO Placeholder (Hidden) -->
        <audio id="crack-sound" preload="auto">
            <source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg">
        </audio>

        <script>
            // --- CORE CORE ---
            const state = {
                view: 'home',
                hits: 0,
                interval: null,
                textSizeIndex: 1, // Default to Small (2nd option)
                themeColorIndex: 0, // Default: White
                fontFamilyIndex: 0, // Default: Sans
                mode: 'text', // 'text' or 'audio'
                globalTheme: localStorage.getItem('release-theme') || 'dark',

                // Audio Context & State
                audioBlob: null,
                isRecording: false,
                isPlaying: false,
                mediaRecorder: null,
                audioChunks: [],
                audioContext: null,
                analyser: null,
                source: null,
                visualizerId: null,
                startTime: null,
                timerInterval: null,
                burnComplete: false,
                hapticsEnabled: true,
                globalTheme: localStorage.getItem('release-theme') || 'dark',

                // Calm Mode Config
                calmBaseTime: 4,
                calmRestTime: 4,
                calmHoldTime: 4,
                calmExhaleTime: 4,
                calmPaused: false,
                activeTechniqueIndex: 0,
                calmTechniques: [
                    { name: 'Box', inhale: 4, hold: 4, exhale: 4, rest: 4, icon: 'fa-square' },
                    { name: '4-7-8', inhale: 4, hold: 7, exhale: 8, rest: 0, icon: 'fa-wind' },
                    { name: 'Resonant', inhale: 5, hold: 0, exhale: 5, rest: 0, icon: 'fa-wave-square' },
                    { name: 'Equal', inhale: 4, hold: 0, exhale: 4, rest: 0, icon: 'fa-arrows-left-right' },
                    { name: 'Extended', inhale: 4, hold: 1, exhale: 7, rest: 0, icon: 'fa-arrows-to-dot' },
                    { name: 'Belly', inhale: 4, hold: 0, exhale: 6, rest: 0, icon: 'fa-circle-dot' }
                ],

                // Animation & Particles
                particles: [],
                particleLoopActive: false,
                canvas: document.getElementById('burn-canvas'),
                ctx: null, // Initialized only if needed for 2D, but we use WebGL now

                // WebGL Burn State
                burnGl: null,
                burnProgram: null,
                burnTexture: null,
                burnProgress: 0,
                burnCount: 0,
                visualIntensity: 0.0,
                fireAnimationEnabled: localStorage.getItem('fire-animation-enabled') !== 'false',
                isSubmittingBurn: false,

                // Cached elements for performance
                el: {
                    area: document.getElementById('burn-area'),
                    mainBtn: document.getElementById('btn-main-action'),
                    timer: document.getElementById('audio-timer'),
                    status: document.getElementById('audio-status'),
                    visualizer: document.getElementById('audio-visualizer'),
                    editorCard: document.getElementById('editor-card'),
                    navBar: document.getElementById('nav-bar'),
                    burnCanvas: document.getElementById('burn-canvas')
                }
            };


            const textSizes = [
                { class: 'text-lg md:text-2xl', label: 'Tiny' },
                { class: 'text-xl md:text-3xl', label: 'Small' },
                { class: 'text-3xl md:text-5xl', label: 'Medium' }, // Default
                { class: 'text-4xl md:text-6xl', label: 'Large' },
                { class: 'text-5xl md:text-7xl', label: 'Extra' },
                { class: 'text-6xl md:text-8xl', label: 'Huge' }
            ];

            const themeColors = [
                { isCardDark: true, bgClass: 'bg-bg-deep', cardBg: 'bg-text-light/5', textClass: '!text-white', dotColor: 'var(--dot-color)', shadowColor: 'rgba(0,0,0,0.05)', uiBg: 'bg-text-light/5', uiBorder: 'border-text-light/5', uiTextMain: 'text-text-light', uiTextDim: 'text-text-light/50' }, // Void
                { isCardDark: false, bgClass: '!bg-[#fff3e0]/80', cardBg: '!bg-[#fff3e0]', textClass: '!text-gray-900', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.1)', uiBg: 'bg-black/5', uiBorder: 'border-black/10', uiTextMain: 'text-black', uiTextDim: 'text-black/50' }, // Ivory
                { isCardDark: false, bgClass: '!bg-[#e5f3f8]/80', cardBg: '!bg-[#e5f3f8]', textClass: '!text-gray-900', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.1)', uiBg: 'bg-black/5', uiBorder: 'border-black/10', uiTextMain: 'text-black', uiTextDim: 'text-black/50' }, // Mist
                { isCardDark: false, bgClass: '!bg-[#dadecf]/80', cardBg: '!bg-[#dadecf]', textClass: '!text-gray-900', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.1)', uiBg: 'bg-black/5', uiBorder: 'border-black/10', uiTextMain: 'text-black', uiTextDim: 'text-black/50' }, // Pewter
                { isCardDark: true, bgClass: '!bg-[#191738]', cardBg: '!bg-white/5', textClass: '!text-white', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.4)', uiBg: 'bg-white/5', uiBorder: 'border-white/5', uiTextMain: 'text-white', uiTextDim: 'text-white/50' }  // Midnight
            ];

            const fontFamilies = [
                { class: 'font-sans', label: 'Outfit' },
                { class: 'font-serif', label: 'Playfair' },
                { class: 'font-mono', label: 'Mono' }
            ];


            function track(event) {
                console.log(`[POSTHOG DUMMY] ${event}`);
                // if(typeof posthog !== 'undefined') posthog.capture(event);
            }

            // --- NAVIGATION ---
            function navigate(viewId) {
                document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
                const target = document.getElementById(`view-${viewId}`);
                target.classList.add('active');
                state.view = viewId;

                // Header state - Dim secondary items, keep logo and waitlist bright
                const nav = document.getElementById('nav-bar');
                const navWaitlist = nav.querySelector('button[onclick*="toggleWaitlist"]');
                const navLogo = nav.querySelector('div[onclick*="navigate(\'home\')"]');
                const navShare = nav.querySelector('button[onclick*="shareLink"]');

                if (viewId === 'home') {
                    nav.style.opacity = '1';
                    if (navShare) navShare.style.opacity = '1';
                } else {
                    // Overall header slightly dimmed but important items forced bright
                    nav.style.opacity = '1';
                    if (navLogo) navLogo.style.opacity = '0.6';
                    if (navShare) navShare.style.opacity = '1';
                    // Waitlist button stays 100%
                }

                // Feature Inits
                if (state.view === 'calm' && viewId !== 'calm') {
                    if (state.interval) {
                        clearTimeout(state.interval);
                        state.interval = null;
                    }
                    if (state.timerInterval) {
                        clearInterval(state.timerInterval);
                        state.timerInterval = null;
                    }
                }

                if (viewId === 'calm') {
                    initCalmPresets();
                    runCalmLoop();
                }
                const toolbar = document.querySelector('#editor-card > .absolute.bottom-0');
                if (toolbar) toolbar.classList.remove('opacity-0', 'pointer-events-none');

                if (viewId === 'burn') {
                    setupCanvas();
                    // Always show canvas on burn page for scraping effect
                    const burnCanvas = document.getElementById('burn-canvas');
                    if (burnCanvas) {
                        burnCanvas.style.display = 'block';
                        requestAnimationFrame(renderAtmos);
                    }
                    // Auto-focus Ash area
                    setTimeout(() => {
                        const area = document.getElementById('burn-area');
                        if (area && state.mode === 'text' && !state.isSubmittingBurn) {
                            area.focus();
                        }
                    }, 100);
                } else {
                    // Hide canvas on other pages
                    const burnCanvas = document.getElementById('burn-canvas');
                    if (burnCanvas) burnCanvas.style.display = 'none';
                }

                track(`App ${viewId.charAt(0).toUpperCase() + viewId.slice(1)} Opened`);
            }

            track('App Opened');

            let lastCanvasWidth = 0;
            let lastCanvasHeight = 0;
            function setupCanvas() {
                const widthChanged = Math.abs(window.innerWidth - lastCanvasWidth) > 10;
                const heightChanged = Math.abs(window.innerHeight - lastCanvasHeight) > 100;

                if (!widthChanged && !heightChanged && state.canvas.width > 0) return;

                lastCanvasWidth = window.innerWidth;
                lastCanvasHeight = window.innerHeight;

                const dpr = window.devicePixelRatio || 1;
                state.canvas.width = window.innerWidth * dpr;
                state.canvas.height = window.innerHeight * dpr;

                if (state.burnGl) {
                    state.burnGl.viewport(0, 0, state.canvas.width, state.canvas.height);

                    // Force render immediately to prevent flicker
                    if (state.view === 'burn' && !state.isSubmittingBurn && state.burnProgram) {
                        const gl = state.burnGl;
                        gl.useProgram(state.burnProgram);
                        gl.clearColor(0, 0, 0, 0);
                        gl.clear(gl.COLOR_BUFFER_BIT);
                        if (state.uBurnTime) {
                            gl.uniform1f(state.uBurnTime, performance.now() / 1000);
                            gl.uniform1f(state.uBurnProgress, 0);
                            gl.uniform1f(state.uBurnIntensity, state.visualIntensity);
                            gl.uniform2f(state.uBurnResolution, state.canvas.width, state.canvas.height);
                            gl.uniform1f(state.uBurnDpr, window.devicePixelRatio || 1);
                            gl.uniform2f(state.uBurnCardPos, -1000, -1000);
                        }
                        gl.drawArrays(gl.TRIANGLES, 0, 6);
                    }
                }
            }

            function initBurnWebGL() {
                const gl = state.canvas.getContext('webgl', { alpha: true, premultipliedAlpha: false });
                if (!gl) return;
                state.burnGl = gl;

                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                const createShader = (gl, type, sourceId) => {
                    const shader = gl.createShader(type);
                    gl.shaderSource(shader, document.getElementById(sourceId).text);
                    gl.compileShader(shader);
                    return shader;
                };

                const vs = createShader(gl, gl.VERTEX_SHADER, 'vs-burn');
                const fs = createShader(gl, gl.FRAGMENT_SHADER, 'fs-burn');
                const program = gl.createProgram();
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.linkProgram(program);
                state.burnProgram = program;
                gl.useProgram(program);

                const vertices = new Float32Array([-1, -1, 1, -1, -1, 1, 1, -1, -1, 1, 1, 1]);
                const buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

                const posAttrib = gl.getAttribLocation(program, 'position');
                gl.enableVertexAttribArray(posAttrib);
                gl.vertexAttribPointer(posAttrib, 2, gl.FLOAT, false, 0, 0);

                state.uBurnTexture = gl.getUniformLocation(program, 'uTexture');
                state.uBurnTime = gl.getUniformLocation(program, 'uTime');
                state.uBurnProgress = gl.getUniformLocation(program, 'uProgress');
                state.uBurnSeed = gl.getUniformLocation(program, 'uSeed');
                state.uBurnCardSize = gl.getUniformLocation(program, 'uCardSize');
                state.uBurnCardPos = gl.getUniformLocation(program, 'uCardPos');
                state.uBurnResolution = gl.getUniformLocation(program, 'uResolution');
                state.uBurnIntensity = gl.getUniformLocation(program, 'uIntensity');
                state.uBurnDpr = gl.getUniformLocation(program, 'uDpr');
            }
            initBurnWebGL();
            renderAtmos();

            function renderAtmos() {
                if (state.view !== 'burn') {
                    requestAnimationFrame(renderAtmos);
                    return;
                }

                // If we are burning the card, the card animation loop takes over
                if (!state.isSubmittingBurn) {
                    const gl = state.burnGl;
                    if (gl) {
                        gl.useProgram(state.burnProgram);
                        gl.clearColor(0, 0, 0, 0);
                        gl.clear(gl.COLOR_BUFFER_BIT);
                        gl.uniform1f(state.uBurnTime, performance.now() / 1000);
                        gl.uniform1f(state.uBurnProgress, 0); // No card burn

                        // Lerp visual intensity for smooth transitions
                        // Limit to Dark Mode + Animation Enabled (Bottom ONLY in Dark Mode)
                        const isFireActive = state.globalTheme === 'dark' && state.fireAnimationEnabled;
                        const targetIntensity = isFireActive ? Math.pow(0.9, state.burnCount) : 0.0;
                        state.visualIntensity += (targetIntensity - state.visualIntensity) * 0.05;
                        gl.uniform1f(state.uBurnIntensity, state.visualIntensity);

                        gl.uniform2f(state.uBurnResolution, state.canvas.width, state.canvas.height);
                        gl.uniform1f(state.uBurnDpr, window.devicePixelRatio || 1);
                        // Hide card uniforms by setting large negative pos
                        gl.uniform2f(state.uBurnCardPos, -1000, -1000);
                        gl.drawArrays(gl.TRIANGLES, 0, 6);
                    }
                }
                requestAnimationFrame(renderAtmos);
            }

            function createParticle(x, y) {
                return {
                    x, y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 1.5) * 4,
                    life: 1.0,
                    size: Math.random() * 4
                };
            }

            function renderParticles() {
                // Disabled in favor of WebGL burn effect
                return;
            }

            function handleMainAction() {
                const area = document.getElementById('burn-area');
                const mainBtn = document.getElementById('btn-main-action');

                // AUDIO MODE
                if (state.mode === 'audio') {
                    // Case 1: Start Recording
                    if (!state.isRecording && !state.audioBlob) {
                        toggleRecording();
                        return;
                    }
                    // Case 2: Stop Recording
                    if (state.isRecording) {
                        stopRecording();
                        return;
                    }
                    // Case 3: Burn It (Recorded)
                    if (state.audioBlob) {
                        performBurn();
                        return;
                    }
                    return;
                }

                // TEXT MODE
                if (state.mode === 'text' && area.value.trim().length > 0) {
                    performBurn();
                    return;
                }
            }
            // Expose to window to ensure HTML onclick can see it
            window.handleMainAction = handleMainAction;

            function performBurn() {
                const area = document.getElementById('burn-area');
                const btn = document.getElementById('btn-main-action');

                // AUDIO MODE BURN
                if (state.mode === 'audio') {
                    if (!state.audioBlob && !state.isRecording) return;

                    track('Audio Ashed');

                    // Visual Glitch Effect on Canvas
                    const canvas = document.getElementById('audio-visualizer');
                    canvas.classList.add('transition-all', 'duration-[1s]', 'blur-xl', 'scale-150', 'opacity-0');

                    state.burnComplete = true;

                    setTimeout(() => {
                        if (state.globalTheme === 'dark') state.burnCount++;
                        resetMode('burn');
                        const mkt = document.getElementById('burn-marketing');
                        mkt.classList.remove('hidden');

                        // Hide footer to prevent overscroll and visual clutter
                        const footer = document.getElementById('ash-footer');
                        if (footer) footer.classList.add('hidden');

                        // Sync scroll with fly-in safely
                        setTimeout(() => {
                            mkt.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 500);
                    }, 1000);
                    return;
                }

                // TEXT MODE BURN
                if (!area.value.trim() || state.isSubmittingBurn) return;

                state.isSubmittingBurn = true;
                track('Ashed');

                // Instant UI Feedback
                btn.innerHTML = `<i class="fa-solid fa-fire animate-pulse mr-2"></i> Igniting...`;
                btn.classList.add('scale-95');

                if (state.hapticsEnabled && navigator.vibrate) {
                    navigator.vibrate(50);
                }

                // Capture the card instantly without html2canvas
                if (!state.burnGl) {
                    initBurnWebGL();
                }

                // Start animation loop immediately for flare
                state.burnProgress = 0;
                requestAnimationFrame(animateBurn);

                // Hide inner toolbar during burn
                const toolbar = document.querySelector('#editor-card > .absolute.bottom-0');
                if (toolbar) toolbar.classList.add('opacity-0', 'pointer-events-none');

                // HIGH-SPEED CUSTOM TEXT RENDERER
                // Bypasses the synchronous layout engine lag of html2canvas entirely
                const dpr = window.devicePixelRatio || 1;
                const rect = state.el.editorCard.getBoundingClientRect();
                const areaRect = area.getBoundingClientRect();

                // Create offscreen canvas exactly the size of the editor card
                const cardCanvas = document.createElement('canvas');
                cardCanvas.width = rect.width * dpr;
                cardCanvas.height = rect.height * dpr;
                const ctx = cardCanvas.getContext('2d');
                ctx.scale(dpr, dpr);

                // Get exact computed styles from the textarea to mimic it perfectly
                const computed = window.getComputedStyle(area);

                // Draw text
                ctx.font = `${computed.fontWeight} ${computed.fontSize} ${computed.fontFamily}`;
                ctx.fillStyle = computed.color;
                ctx.textBaseline = 'top';

                // Calculate Exact Relative Coordinates
                // Text starts at the exact pixel difference between the text area's edge and the parent card's edge
                const fontSize = parseFloat(computed.fontSize);
                const lineHeight = parseFloat(computed.lineHeight) || (fontSize * 1.5);

                // In CSS, line-height adds "half-leading" to the top and bottom of every line. We must push the canvas down by this amount.
                const halfLeading = (lineHeight - fontSize) / 2;
                const textStartX = areaRect.left - rect.left + (parseFloat(computed.paddingLeft) || 0) - area.scrollLeft;
                const textStartY = areaRect.top - rect.top + (parseFloat(computed.paddingTop) || 0) + halfLeading - area.scrollTop;

                // Handle basic text wrapping (split by newlines, then by width)
                const text = area.value;
                const lines = text.split('\n');
                let y = textStartY;
                const x = textStartX;
                const maxWidth = areaRect.width - (parseFloat(computed.paddingLeft) || 0) - (parseFloat(computed.paddingRight) || 0);

                lines.forEach(line => {
                    const words = line.split(' ');
                    let currentLine = '';

                    words.forEach(word => {
                        const testLine = currentLine + word + ' ';
                        const metrics = ctx.measureText(testLine);

                        if (metrics.width > maxWidth && currentLine !== '') {
                            ctx.fillText(currentLine, x, y);
                            currentLine = word + ' ';
                            y += lineHeight;
                        } else {
                            currentLine = testLine;
                        }
                    });
                    ctx.fillText(currentLine, x, y);
                    y += lineHeight;
                });

                // Send instant canvas to WebGL
                const gl = state.burnGl;
                const program = state.burnProgram;
                gl.useProgram(program);

                // Create texture
                if (state.burnTexture) gl.deleteTexture(state.burnTexture);
                state.burnTexture = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, state.burnTexture);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, cardCanvas);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

                // Set uniforms
                gl.uniform2f(state.uBurnCardSize, rect.width * dpr, rect.height * dpr);
                gl.uniform2f(state.uBurnCardPos, (rect.left + rect.width / 2) * dpr, (rect.top + rect.height / 2) * dpr);
                gl.uniform2f(state.uBurnResolution, state.canvas.width, state.canvas.height);
                gl.uniform1f(state.uBurnDpr, window.devicePixelRatio || 1);
                gl.uniform1f(state.uBurnSeed, Math.random() * 100.0);

                // Hide original card
                state.el.editorCard.classList.add('is-burning');
                btn.classList.remove('scale-95'); // Reset animation state
            }

            function animateBurn() {
                if (!state.isSubmittingBurn) return;

                // Only increment progress if we have a texture (capture complete)
                if (state.burnTexture) {
                    state.burnProgress += 0.012;
                }

                if (state.burnProgress > 1.1) {
                    const gl = state.burnGl;
                    state.isSubmittingBurn = false;
                    gl.clear(gl.COLOR_BUFFER_BIT);

                    // Finish the flow
                    if (state.globalTheme === 'dark') state.burnCount++;
                    resetMode('burn');
                    const mkt = document.getElementById('burn-marketing');
                    mkt.classList.remove('hidden');

                    const footer = document.getElementById('ash-footer');
                    if (footer) footer.classList.add('hidden');

                    setTimeout(() => {
                        mkt.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 500);
                    return;
                }

                const gl = state.burnGl;
                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT);

                gl.uniform1f(state.uBurnTime, performance.now() / 1000);
                gl.uniform1f(state.uBurnProgress, state.burnProgress);

                // Lerp visual intensity here too
                // Limit to Dark Mode + Animation Enabled (Bottom ONLY in Dark Mode)
                const isFireActive = state.globalTheme === 'dark' && state.fireAnimationEnabled;
                const targetIntensity = isFireActive ? Math.pow(0.9, state.burnCount) : 0.0;
                state.visualIntensity += (targetIntensity - state.visualIntensity) * 0.05;
                gl.uniform1f(state.uBurnIntensity, state.visualIntensity);
                gl.uniform1f(state.uBurnDpr, window.devicePixelRatio || 1);

                gl.drawArrays(gl.TRIANGLES, 0, 6);

                requestAnimationFrame(animateBurn);
            }

            // --- AUDIO LOGIC ---
            function toggleMode() {
                const btn = document.getElementById('ui-btn-mode');
                const textArea = document.getElementById('burn-area');
                const audioWrapper = document.getElementById('audio-wrapper');

                // Controls containers
                const fontCtrl = document.getElementById('ctrl-font-container');
                const themeCtrl = document.getElementById('ctrl-theme-container');
                const familyCtrl = document.getElementById('ctrl-family-container');
                const hapticMobile = document.getElementById('ctrl-haptic-mobile');

                if (state.mode === 'text') {
                    state.mode = 'audio';
                    btn.innerHTML = '<i class="fa-solid fa-align-left"></i><span>Text</span>';

                    // Mode Visibility
                    fontCtrl.classList.add('hidden');
                    themeCtrl.classList.add('hidden');
                    familyCtrl.classList.add('hidden');
                    hapticMobile.classList.remove('hidden');
                    hapticMobile.classList.add('flex');

                    // Dynamic adaptation for the toggle button itself
                    const isActualDark = (state.themeColorIndex === 0) ? (state.globalTheme === 'dark') : themeColors[state.themeColorIndex].isCardDark;
                    btn.classList.remove('bg-white/5', 'bg-black/5', 'bg-white/20', 'bg-black/20', 'opacity-40', 'opacity-70');
                    btn.classList.add(isActualDark ? 'bg-white/20' : 'bg-black/20', 'opacity-100');

                    // Update Main Button for Audio
                    document.getElementById('btn-main-action').innerText = "RECORD";

                    textArea.classList.add('opacity-0', 'pointer-events-none');
                    audioWrapper.classList.remove('hidden', 'pointer-events-none');
                    // Small delay to allow display:block to apply before opacity transition
                    setTimeout(() => audioWrapper.classList.remove('opacity-0'), 10);

                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();
                    initAudio();
                } else {
                    state.mode = 'text';
                    btn.innerHTML = '<i class="fa-solid fa-microphone"></i><span>Voice</span>';

                    // Mode Visibility
                    fontCtrl.classList.remove('hidden');
                    themeCtrl.classList.remove('hidden');
                    familyCtrl.classList.remove('hidden');
                    hapticMobile.classList.add('hidden');
                    hapticMobile.classList.remove('flex');

                    const isActualDark = (state.themeColorIndex === 0) ? (state.globalTheme === 'dark') : themeColors[state.themeColorIndex].isCardDark;
                    btn.classList.remove('bg-white/20', 'bg-black/20', 'opacity-100');
                    btn.classList.add(isActualDark ? 'bg-white/5' : 'bg-black/5', 'opacity-70');

                    // Update Main Button for Text
                    document.getElementById('btn-main-action').innerHTML = `<span>Ash It</span><kbd class="ml-2 opacity-50 text-[11px] border border-white/20 px-1.5 py-0.5 rounded font-medium lowercase pointer-events-none tracking-normal">Ctrl+Enter</kbd>`;

                    audioWrapper.classList.add('opacity-0');
                    setTimeout(() => {
                        audioWrapper.classList.add('hidden', 'pointer-events-none');
                        textArea.classList.remove('opacity-0', 'pointer-events-none');
                    }, 300);

                    stopRecording(); // Safety stop

                    // Reset Button Style/Opacity for Text mode
                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();

                    // Cleanup Audio Resources
                    if (state.source) {
                        state.source.mediaStream.getTracks().forEach(track => track.stop());
                        state.source = null;
                    }
                    if (state.audioContext) {
                        state.audioContext.close();
                        state.audioContext = null;
                    }
                }
            }


            async function initAudio() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    state.analyser = state.audioContext.createAnalyser();
                    state.source = state.audioContext.createMediaStreamSource(stream);
                    state.source.connect(state.analyser);

                    state.analyser.fftSize = 256;
                    drawVisualizer();

                    // MIME Type Detection for Safari/iOS
                    const mimeTypes = [
                        'audio/webm;codecs=opus',
                        'audio/webm',
                        'audio/mp4',
                        'audio/ogg',
                        'audio/wav',
                        'audio/aac'
                    ];
                    let selectedMimeType = '';
                    for (const type of mimeTypes) {
                        if (MediaRecorder.isTypeSupported(type)) {
                            selectedMimeType = type;
                            break;
                        }
                    }

                    if (!selectedMimeType) {
                        console.warn('No standard MIME type supported, letting browser choose default.');
                    } else {
                        console.log('Using MIME type:', selectedMimeType);
                    }

                    const options = selectedMimeType ? { mimeType: selectedMimeType } : {};
                    state.mediaRecorder = new MediaRecorder(stream, options);

                    state.mediaRecorder.ondataavailable = e => {
                        if (e.data && e.data.size > 0) {
                            state.audioChunks.push(e.data);
                        }
                    };

                    state.mediaRecorder.onerror = e => {
                        console.error('MediaRecorder Error:', e);
                        alert('Recording error: ' + e.error.message);
                    };

                    state.mediaRecorder.onstop = () => {
                        const blobType = selectedMimeType || 'audio/webm'; // Fallback
                        state.audioBlob = new Blob(state.audioChunks, { type: blobType });
                        state.audioChunks = [];
                        console.log('Recording stopped. Blob created with type:', blobType, 'Size:', state.audioBlob.size);
                    };
                } catch (err) {
                    console.error('Mic Error:', err);
                    alert('Microphone access needed for Voice Ash. ' + err.message);
                    toggleMode(); // Go back to text
                }
            }

            function toggleRecording() {
                if (!state.mediaRecorder) {
                    alert("Microphone not ready. Please allow access and try again.");
                    // Attempt re-init if stuck?
                    if (state.mode === 'audio') initAudio();
                    return;
                }

                // const recBtnIndicator = document.getElementById('record-indicator'); // REMOVED
                const statusText = document.getElementById('audio-status');
                // const btnRecord = document.getElementById('btn-record'); // REMOVED
                const mainBtn = document.getElementById('btn-main-action');

                if (state.isRecording) {
                    stopRecording();
                } else {
                    // Start
                    state.isRecording = true;
                    // Clear previous blob if any
                    state.audioBlob = null;
                    state.audioChunks = [];
                    document.getElementById('btn-play-audio').classList.add('hidden');
                    // document.getElementById('btn-download-audio').classList.add('hidden');

                    state.mediaRecorder.start();
                    mainBtn.innerText = "STOP"; // Update Main Button
                    mainBtn.classList.add('bg-red-600', 'animate-pulse'); // Add visual cue

                    statusText.innerText = "Recording...";
                    statusText.classList.add('text-nexus-orange', 'animate-pulse');
                    statusText.classList.remove('opacity-40');

                    // Timer
                    state.startTime = Date.now();
                    state.timerInterval = setInterval(updateTimer, 1000);
                }
            }

            function stopRecording() {
                if (!state.isRecording) return;
                state.isRecording = false;
                if (state.mediaRecorder.state !== 'inactive') state.mediaRecorder.stop();

                clearInterval(state.timerInterval);

                state.el.mainBtn.innerText = "ASH IT"; // Update Main Button
                state.el.mainBtn.classList.remove('bg-red-600', 'animate-pulse');

                state.el.status.innerText = "Ready to Burn";
                state.el.status.classList.remove('text-nexus-orange', 'animate-pulse');
                state.el.status.classList.add('opacity-40');

                // Show Play button
                document.getElementById('btn-play-audio').classList.remove('hidden');
                // document.getElementById('btn-download-audio').classList.remove('hidden');
            }

            function updateTimer() {
                const diff = Math.floor((Date.now() - state.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const S = (diff % 60).toString().padStart(2, '0');
                state.el.timer.innerText = `${m}:${S}`;
            }

            function togglePlayback() {
                if (!state.audioBlob) return;

                const btn = document.getElementById('btn-play-audio');
                const icon = btn.querySelector('i');

                // If currently playing, pause it
                if (state.currentAudio && !state.currentAudio.paused) {
                    state.currentAudio.pause();
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    icon.classList.add('translate-x-1');
                    return;
                }

                // If paused or new, play it
                if (!state.currentAudio) {
                    state.currentAudio = new Audio(URL.createObjectURL(state.audioBlob));
                    state.currentAudio.onended = () => {
                        icon.classList.remove('fa-pause');
                        icon.classList.add('fa-play');
                        icon.classList.add('translate-x-1');
                        state.currentAudio = null;
                    };
                }

                state.currentAudio.play()
                    .then(() => {
                        icon.classList.remove('fa-play');
                        icon.classList.remove('translate-x-1');
                        icon.classList.add('fa-pause');
                    })
                    .catch(e => {
                        console.error("Playback failed:", e);
                        alert("Playback failed: " + e.message);
                    });
            }
            window.togglePlayback = togglePlayback;

            function resetAudioState() {
                // Stop playback if active
                if (state.currentAudio) {
                    state.currentAudio.pause();
                    state.currentAudio = null;
                }
                const btn = document.getElementById('btn-play-audio');
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    icon.classList.add('translate-x-1');
                }

                state.audioBlob = null;
                state.isRecording = false;
                clearInterval(state.timerInterval);
                document.getElementById('audio-timer').innerText = "00:00";
                if (state.hapticsEnabled && navigator.vibrate) navigator.vibrate(50);

                // Reset UI
                const audioWrapper = document.getElementById('audio-wrapper');
                const canvas = document.getElementById('audio-visualizer');
                canvas.classList.remove('transition-all', 'duration-[1s]', 'blur-xl', 'scale-150', 'opacity-0');
                document.getElementById('audio-status').innerText = "Tap to Record";
                document.getElementById('btn-play-audio').classList.add('hidden');
                // document.getElementById('btn-download-audio').classList.add('hidden');

                // Reset Main Button Text
                if (state.mode === 'audio') {
                    document.getElementById('btn-main-action').innerText = "RECORD";
                }
            }

            function drawVisualizer() {
                if (state.mode !== 'audio' || !state.analyser) {
                    cancelAnimationFrame(state.visualizerId);
                    return;
                }

                const canvas = state.el.visualizer;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                const bufferLength = state.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                state.analyser.getByteFrequencyData(dataArray);

                ctx.clearRect(0, 0, width, height);

                const barWidth = 2.5; // Fine bars
                const gap = 3;
                const barCount = Math.floor(width / (barWidth + gap));

                const isActualDark = (state.themeColorIndex === 0) ? (state.globalTheme === 'dark') : themeColors[state.themeColorIndex].isCardDark;
                const isActive = state.isRecording;

                // Move fillStyle and path initiation out of loop for performance
                if (isActive) {
                    ctx.fillStyle = 'rgba(255, 69, 0, 0.8)';
                } else if (isActualDark) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                } else {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                }

                ctx.beginPath();
                const radius = barWidth / 2;

                for (let i = 0; i < barCount; i++) {
                    const percent = i / barCount;
                    const freqIdx = Math.floor(Math.pow(percent, 0.75) * (bufferLength * 0.7));
                    const value = dataArray[freqIdx];

                    let barHeight = (value / 255) * height * 1.5;
                    if (barHeight < 6) barHeight = 6;
                    if (barHeight > height) barHeight = height;

                    const x = i * (barWidth + gap);
                    const y = (height - barHeight) / 2;

                    if (ctx.roundRect) {
                        ctx.roundRect(x, y, barWidth, barHeight, radius);
                    } else {
                        ctx.rect(x, y, barWidth, barHeight);
                    }
                }
                ctx.fill();

                state.visualizerId = requestAnimationFrame(drawVisualizer);
            }

            function resetMode(mode) {
                if (mode === 'burn') {
                    state.burnComplete = false;
                    state.el.area.value = '';

                    // Reset Button Style & Text
                    if (state.mode === 'text') {
                        state.el.mainBtn.innerHTML = `<span>Ash It</span> <kbd class="ml-2 opacity-50 text-[11px] border border-white/20 px-1.5 py-0.5 rounded font-medium pointer-events-none tracking-normal hidden md:inline-block">⌘ / Ctrl + ⏎</kbd>`;
                    } else {
                        state.el.mainBtn.innerText = "RECORD";
                    }
                    state.el.mainBtn.classList.remove('scale-95');
                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();

                    // Reset Audio
                    if (state.mode === 'audio') {
                        resetAudioState();
                    }

                    // Remove animation classes
                    state.el.area.classList.remove('transition-all', 'duration-[1.5s]', 'blur-2xl', 'opacity-0', 'scale-90');
                    state.el.editorCard.classList.remove('is-burning');

                    // Re-apply current settings to ensure consistency
                    const toolbar = document.querySelector('#editor-card > .absolute.bottom-0');
                    if (toolbar) {
                        toolbar.classList.remove('opacity-0', 'pointer-events-none');
                    }
                    document.getElementById('burn-marketing').classList.add('hidden');
                    const footer = document.getElementById('ash-footer');
                    if (footer) footer.classList.remove('hidden');
                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();
                }
                if (mode === 'smash') {
                    state.hits = 0;
                    document.querySelectorAll('.crack-layer').forEach(c => c.remove());
                    document.getElementById('smash-marketing').classList.add('hidden');
                    document.getElementById('smash-hint').innerText = "Tap repeatedly to release energy";
                }
            }

            // --- SMASH IT ---
            function triggerHammer(e) {
                if (state.hits >= 10) return;
                state.hits++;
                track('Smashed');

                // Haptic
                if (navigator.vibrate) navigator.vibrate(50);

                // Audio
                const sound = document.getElementById('crack-sound');
                sound.currentTime = 0;
                sound.play().catch(e => { });

                // Visual
                const crack = document.createElement('img');
                crack.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M10,10 L30,40 L5,60 M30,40 L60,30 L90,10 M60,30 L70,80 L40,90 M70,80 L95,65' stroke='white' fill='none' stroke-width='0.5'/%3E%3C/svg%3E";
                crack.className = 'crack-layer w-40';
                crack.style.left = `${e.clientX - 80}px`;
                crack.style.top = `${e.clientY - 80}px`;
                crack.style.transform = `rotate(${Math.random() * 360}deg) scale(${0.8 + Math.random()})`;
                document.getElementById('view-smash').appendChild(crack);

                document.getElementById('smash-hint').innerText = `${state.hits} / 10`;

                if (state.hits >= 10) {
                    setTimeout(() => {
                        document.getElementById('smash-marketing').classList.remove('hidden');
                    }, 400);
                }
            }

            // --- CALM IT ---
            function initCalmPresets() {
                const list = document.getElementById('calm-presets-list');
                if (!list) return;
                list.innerHTML = state.calmTechniques.map((t, idx) => `
                    <div onclick="setTechnique(${idx})" 
                        title="${t.name}"
                        class="preset-pill snap-start flex-shrink-0 w-11 h-11 rounded-full flex items-center justify-center cursor-pointer transition-all backdrop-blur-xl ${state.activeTechniqueIndex === idx ? 'bg-black/20 text-black scale-110 shadow-lg' : 'bg-white/10 text-black/30 hover:bg-white/20 hover:scale-105'}">
                        <i class="fa-solid ${t.icon} text-sm"></i>
                    </div>
                `).join('');

                // Set initial active technique
                const tech = state.calmTechniques[state.activeTechniqueIndex];
                document.getElementById('active-technique-name').innerText = tech.name + ' Breathing';
                updateCalmDisplay();
                initCalmVisualizer();
            }
            window.initCalmPresets = initCalmPresets;

            function setTechnique(idx) {
                state.activeTechniqueIndex = idx;
                const tech = state.calmTechniques[idx];

                // Update State
                state.calmBaseTime = tech.inhale;
                state.calmHoldTime = tech.hold;
                state.calmExhaleTime = tech.exhale;
                state.calmRestTime = tech.rest;

                // Refresh UI
                document.getElementById('active-technique-name').innerText = tech.name + ' Breathing';
                initCalmPresets(); // Re-render list for active state
                updateCalmStyles();

                // Always force reset to Inhale phase when switching techniques
                runCalmLoop(0, null);

                // If switch happens while paused, ensure internal state is primed for Inhale
                if (state.calmPaused) {
                    state.currentCalmPhase = 0;
                    state.currentPhaseStartTime = performance.now();
                }

                if (navigator.vibrate) navigator.vibrate(10);
            }
            window.setTechnique = setTechnique;

            function updateCalmDisplay() {
                const tech = state.calmTechniques[state.activeTechniqueIndex];
                document.getElementById('display-inhale').innerText = state.calmBaseTime;
                document.getElementById('display-hold').innerText = state.calmHoldTime;
                document.getElementById('display-exhale').innerText = state.calmExhaleTime;
                document.getElementById('display-rest').innerText = state.calmRestTime;
            }

            function initCalmVisualizer() {
                const canvas = document.getElementById('calm-visualizer');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                canvas.width = canvas.clientWidth * dpr;
                canvas.height = canvas.clientHeight * dpr;
                ctx.scale(dpr, dpr);

                state.calmVisCtx = ctx;
                state.calmVisWidth = canvas.clientWidth;
                state.calmVisHeight = canvas.clientHeight;

                if (!state.calmVisActive) {
                    state.calmVisActive = true;
                    requestAnimationFrame(animateCalmVis);
                }
            }

            function animateCalmVis() {
                if (state.view !== 'calm') {
                    state.calmVisActive = false;
                    return;
                }

                if (state.calmPaused) {
                    requestAnimationFrame(animateCalmVis);
                    return;
                }

                const ctx = state.calmVisCtx;
                if (!ctx) return;

                const w = state.calmVisWidth;
                const h = state.calmVisHeight;
                ctx.clearRect(0, 0, w, h);

                const tech = state.calmTechniques[state.activeTechniqueIndex];

                // --- Phase Management ---
                const phases = [
                    { text: "Inhale", duration: state.calmBaseTime },
                    { text: "Hold", duration: state.calmHoldTime },
                    { text: "Exhale", duration: state.calmExhaleTime },
                    { text: "Rest", duration: state.calmRestTime }
                ].filter(p => p.duration > 0 || p.text === "Inhale" || p.text === "Exhale");

                let now = performance.now();
                let elapsed = now - state.currentPhaseStartTime;

                // Handle Phase Transition
                if (elapsed >= state.currentPhaseDuration) {
                    const overflow = elapsed - state.currentPhaseDuration;
                    state.currentCalmPhase = (state.currentCalmPhase + 1) % phases.length;
                    const nextPhaseData = phases[state.currentCalmPhase];

                    state.currentPhaseDuration = nextPhaseData.duration * 1000;
                    state.currentPhaseStartTime = now - overflow;
                    elapsed = now - state.currentPhaseStartTime;

                    // Update UI Text immediately on transition
                    document.getElementById('breathing-txt').innerText = nextPhaseData.text;
                }

                const progress = Math.min(1, elapsed / state.currentPhaseDuration);

                // Update Countdown UI based on high-precision time
                const timeLeftSec = Math.ceil((state.currentPhaseDuration - elapsed) / 1000);
                const countdownEl = document.getElementById('calm-timer-countdown');
                if (countdownEl && countdownEl.innerText != timeLeftSec && timeLeftSec >= 0) {
                    countdownEl.innerText = timeLeftSec;
                }

                // Physics/Dynamic Visualization based on technique
                if (tech.name === 'Box') {
                    renderBoxVis(ctx, w, h, state.currentCalmPhase, progress);
                } else {
                    renderFlowVis(ctx, w, h, state.currentCalmPhase, progress);
                }

                requestAnimationFrame(animateCalmVis);
            }

            function renderBoxVis(ctx, w, h, phase, progress) {
                const size = 200;
                const x = (w - size) / 2;
                const y = (h - size) / 2;

                // Draw Square Path
                ctx.strokeStyle = 'rgba(0,0,0,0.05)';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, size, size);

                // Dot Position
                let dotX, dotY;
                if (phase === 0) { // Inhale (Up)
                    dotX = x + progress * size;
                    dotY = y;
                } else if (phase === 1) { // Hold (Right)
                    dotX = x + size;
                    dotY = y + progress * size;
                } else if (phase === 2) { // Exhale (Bottom)
                    dotX = x + size - progress * size;
                    dotY = y + size;
                } else { // Rest (Left)
                    dotX = x;
                    dotY = y + size - progress * size;
                }

                // Draw Dot
                ctx.fillStyle = 'var(--calm-blue)';
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(135, 206, 235, 0.5)';
                ctx.beginPath();
                ctx.arc(dotX, dotY, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            function renderFlowVis(ctx, w, h, phase, progress) {
                const centerX = w / 2;
                const centerY = h / 2;
                const maxRadius = 120;
                const baseRadius = 60;

                let radius = baseRadius;
                if (phase === 0) { // Inhale
                    radius = baseRadius + (maxRadius - baseRadius) * progress;
                } else if (phase === 1) { // Hold
                    radius = maxRadius;
                } else if (phase === 2) { // Exhale
                    radius = maxRadius - (maxRadius - baseRadius) * progress;
                } else { // Rest
                    radius = baseRadius;
                }

                // Flowing Gradient Circle
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                const grd = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                grd.addColorStop(0, 'rgba(135, 206, 235, 0.2)');
                grd.addColorStop(1, 'rgba(135, 206, 235, 0.05)');
                ctx.fillStyle = grd;
                ctx.fill();

                ctx.strokeStyle = 'rgba(135, 206, 235, 0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            function adjustCalmTime(delta) {
                // Now disabled/hidden in the new UI, but keeping logic for internal use if needed
                state.calmBaseTime = Math.max(3, Math.min(10, state.calmBaseTime + delta));
                updateCalmStyles();
                if (!state.calmPaused) {
                    runCalmLoop();
                }
            }
            window.adjustCalmTime = adjustCalmTime;

            function updateCalmStyles() {
                const base = state.calmBaseTime;
                const hold = state.calmHoldTime;
                const exhale = state.calmExhaleTime;
                const rest = state.calmRestTime;
                const total = base + hold + exhale + rest;

                // Update Display Numbers
                if (document.getElementById('display-inhale')) {
                    updateCalmDisplay();
                }

                let calmStyle = document.getElementById('dynamic-calm-style');
                if (!calmStyle) {
                    calmStyle = document.createElement('style');
                    calmStyle.id = 'dynamic-calm-style';
                    document.head.appendChild(calmStyle);
                }

                calmStyle.innerHTML = `
                    :root { --calm-duration: ${total}s; }
                    .preset-pill { transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
                    .no-scrollbar::-webkit-scrollbar { display: none; }
                    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
                `;
            }

            function adjustRestTime(delta) {
                state.calmRestTime = Math.max(1, Math.min(10, state.calmRestTime + delta));
                document.getElementById('calm-rest-display').innerText = state.calmRestTime;
                updateCalmStyles();
                if (!state.calmPaused) {
                    runCalmLoop();
                }
            }
            window.adjustRestTime = adjustRestTime;

            function toggleCalmPause() {
                state.calmPaused = !state.calmPaused;
                const btn = document.getElementById('btn-calm-pause');
                const icon = btn.querySelector('i');

                if (state.calmPaused) {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    // Phase-perfect pause handled by the animation loop
                } else {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                    runCalmLoop(state.currentCalmPhase, state.currentCalmTimeLeft);
                }
                updateCalmStyles();
            }
            window.toggleCalmPause = toggleCalmPause;

            function runCalmLoop(startPhase = 0, startTimeLeft = null) {
                const txt = document.getElementById('breathing-txt');
                const countdownEl = document.getElementById('calm-timer-countdown');

                const phases = [
                    { text: "Inhale", duration: state.calmBaseTime },
                    { text: "Hold", duration: state.calmHoldTime },
                    { text: "Exhale", duration: state.calmExhaleTime },
                    { text: "Rest", duration: state.calmRestTime }
                ].filter(p => p.duration > 0 || p.text === "Inhale" || p.text === "Exhale");

                state.currentCalmPhase = startPhase % phases.length;
                const current = phases[state.currentCalmPhase];

                txt.innerText = current.text;

                const timeLeft = startTimeLeft !== null ? startTimeLeft : current.duration;
                state.currentPhaseDuration = current.duration * 1000;
                state.currentPhaseStartTime = performance.now();
                if (startTimeLeft !== null) {
                    state.currentPhaseStartTime -= (current.duration - startTimeLeft) * 1000;
                }

                countdownEl.innerText = Math.ceil(timeLeft);

                updateCalmStyles();
                track('Calmed');
            }

            function finishCalm() {
                if (state.interval) {
                    clearTimeout(state.interval);
                    clearInterval(state.timerInterval);
                    state.interval = null;
                }
                document.getElementById('calm-marketing').classList.remove('hidden');
            }

            // --- MODAL & SHARE ---
            function toggleWaitlist(show) {
                const modal = document.getElementById('waitlist-modal');
                const nav = document.getElementById('nav-bar');
                modal.classList.toggle('hidden', !show);
                if (nav) nav.classList.toggle('hidden', show);
                if (show) {
                    if (state.view !== 'home') navigate('home');
                    track('Waitlist Overlay Viewed');
                }
            }

            async function shareLink() {
                try {
                    await navigator.share({
                        title: 'Nexus',
                        text: 'Into the void.',
                        url: window.location.href
                    });
                } catch (e) { }
            }

            function submitInlineWaitlist() {
                const input = document.getElementById('waitlist-email-inline');
                const email = input.value.trim();
                if (!email || !email.includes('@')) {
                    input.classList.add('border-red-500/50');
                    setTimeout(() => input.classList.remove('border-red-500/50'), 2000);
                    return;
                }

                track(`Inline Waitlist Join: ${email}`);

                // Show Success State
                const container = input.parentElement;
                container.innerHTML = `
                    <div class="w-full py-2 text-nexus-orange font-black uppercase tracking-[0.2em] text-[10px] animate-fade">
                        <i class="fa-solid fa-check mr-2"></i> You're on the list
                    </div>
                `;
            }

            window.submitInlineWaitlist = submitInlineWaitlist;

            function toggleEditorMenu() {
                const group = document.getElementById('editor-controls-group');
                // Ensure the 'flex' class is added on mobile when not hidden
                if (group.classList.contains('hidden')) {
                    group.classList.remove('hidden');
                    group.classList.add('flex');
                    // Small delay to allow CSS transition
                    setTimeout(() => group.classList.remove('opacity-0'), 10);
                } else {
                    group.classList.add('opacity-0');
                    setTimeout(() => {
                        if (group.classList.contains('opacity-0')) {
                            group.classList.add('hidden');
                            group.classList.remove('flex');
                        }
                    }, 300);
                }
            }
            window.toggleEditorMenu = toggleEditorMenu;

            // --- PWA ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js').then(reg => {
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available, sw.js skipWaiting() will trigger controllerchange
                                    console.log('New update available.');
                                }
                            };
                        };
                    }).catch(e => console.log('SW Fail'));
                });

                // Reload when new worker takes over
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        window.location.reload();
                        refreshing = true;
                    }
                });
            }

            // Resize handler
            window.addEventListener('resize', setupCanvas);

            // Close controls when clicking elsewhere
            window.addEventListener('click', (e) => {
                if (!e.target.closest('#ctrl-font-container') && !e.target.closest('#ctrl-theme-container') && !e.target.closest('#ctrl-family-container') && !e.target.closest('#btn-mobile-menu') && !e.target.closest('#editor-controls-group')) {
                    toggleControl(null);
                    const group = document.getElementById('editor-controls-group');
                    if (group && !group.classList.contains('hidden')) {
                        group.classList.add('opacity-0');
                        setTimeout(() => {
                            if (group.classList.contains('opacity-0')) group.classList.add('hidden');
                        }, 300);
                    }
                }
            });


            // --- EDITOR CONTROLS ---
            function toggleControl(id) {
                const fontControl = document.getElementById('ctrl-font');
                const themeControl = document.getElementById('ctrl-theme');

                if (id === null) {
                    fontControl.classList.remove('w-32');
                    fontControl.classList.add('w-0');
                    themeControl.classList.remove('w-32', 'pl-4');
                    themeControl.classList.add('w-0');
                    if (document.getElementById('ctrl-family')) {
                        document.getElementById('ctrl-family').classList.remove('w-32', 'pl-4');
                        document.getElementById('ctrl-family').classList.add('w-0');
                    }
                    return;
                }

                const el = document.getElementById(id);
                // Close others
                if (id === 'ctrl-font') {
                    themeControl.classList.remove('w-32', 'pl-4');
                    themeControl.classList.add('w-0');
                    if (document.getElementById('ctrl-family')) {
                        document.getElementById('ctrl-family').classList.remove('w-32', 'pl-4');
                        document.getElementById('ctrl-family').classList.add('w-0');
                    }
                } else if (id === 'ctrl-family') {
                    fontControl.classList.remove('w-32');
                    fontControl.classList.add('w-0');
                    themeControl.classList.remove('w-32', 'pl-4');
                    themeControl.classList.add('w-0');
                } else {
                    fontControl.classList.remove('w-32');
                    fontControl.classList.add('w-0');
                    if (document.getElementById('ctrl-family')) {
                        document.getElementById('ctrl-family').classList.remove('w-32', 'pl-4');
                        document.getElementById('ctrl-family').classList.add('w-0');
                    }
                }

                // Toggle current
                if (id === 'ctrl-font') {
                    if (el.classList.contains('w-0')) {
                        el.classList.remove('w-0');
                        el.classList.add('w-32');
                    } else {
                        el.classList.add('w-0');
                        el.classList.remove('w-32');
                    }
                } else if (id === 'ctrl-theme') { // Theme
                    if (el.classList.contains('w-0')) {
                        el.classList.remove('w-0');
                        el.classList.add('w-32', 'pl-4');
                    } else {
                        el.classList.add('w-0');
                        el.classList.remove('w-32', 'pl-4');
                    }
                } else { // Family
                    if (el.classList.contains('w-0')) {
                        el.classList.remove('w-0');
                        el.classList.add('w-32', 'pl-4');
                    } else {
                        el.classList.add('w-0');
                        el.classList.remove('w-32', 'pl-4');
                    }
                }
            }

            function toggleHaptics() {
                state.hapticsEnabled = !state.hapticsEnabled;
                const btn = document.getElementById('ui-btn-haptic');
                if (state.hapticsEnabled) {
                    btn.classList.add('opacity-100');
                    btn.classList.remove('opacity-40');
                    if (navigator.vibrate) navigator.vibrate(50);
                } else {
                    btn.classList.remove('opacity-100');
                    btn.classList.add('opacity-40');
                }
                track(`Haptics Toggled: ${state.hapticsEnabled}`);
            }
            window.toggleHaptics = toggleHaptics;

            function changeTextSize(val) {
                // If val is provided, use it (slider). Otherwise cycle (button fallback, though button is removed)
                const area = document.getElementById('burn-area');

                // Remove current size class
                area.classList.remove(...textSizes[state.textSizeIndex].class.split(' '));

                if (val !== undefined) {
                    state.textSizeIndex = parseInt(val);
                } else {
                    // Cycle index (fallback)
                    state.textSizeIndex = (state.textSizeIndex + 1) % textSizes.length;
                }

                // Add new size class
                area.classList.add(...textSizes[state.textSizeIndex].class.split(' '));
                track(`Text Size Changed`);
            }

            function changeFontFamily(index) {
                const area = document.getElementById('burn-area');

                // Remove current family class
                area.classList.remove('font-sans', 'font-serif', 'font-mono');
                area.style.fontFamily = ''; // Clear inline if any

                if (index !== undefined) {
                    state.fontFamilyIndex = index;
                } else {
                    state.fontFamilyIndex = (state.fontFamilyIndex + 1) % fontFamilies.length;
                }

                const family = fontFamilies[state.fontFamilyIndex];
                area.classList.add(family.class);

                // Explicitly set for standard Tailwind fonts if needed, or specific Google Fonts
                if (family.class === 'font-serif') area.style.fontFamily = '"Playfair Display", serif';
                if (family.class === 'font-mono') area.style.fontFamily = '"JetBrains Mono", monospace';
                if (family.class === 'font-sans') area.style.fontFamily = '"Outfit", sans-serif';

                track(`Font Family Changed to ${family.label}`);
            }


            function changeThemeColor(index) {
                const view = document.getElementById('view-burn');
                const card = document.getElementById('editor-card');
                const area = document.getElementById('burn-area');

                // Remove current classes
                view.classList.remove(themeColors[state.themeColorIndex].bgClass);
                card.classList.remove(themeColors[state.themeColorIndex].cardBg);

                // Card no longer has theme bg directly (it's glass now)

                // Set new index
                if (index !== undefined) {
                    state.themeColorIndex = index;
                } else {
                    state.themeColorIndex = (state.themeColorIndex + 1) % themeColors.length;
                }

                // Add new classes
                view.classList.add(themeColors[state.themeColorIndex].bgClass);
                card.classList.add(themeColors[state.themeColorIndex].cardBg);

                // Update CSS Variable for dot pattern and shadow
                view.style.setProperty('--dot-color', themeColors[state.themeColorIndex].dotColor);
                card.style.setProperty('--shadow-color', themeColors[state.themeColorIndex].shadowColor);

                // --- DYNAMIC UI UPDATES ---
                const t = themeColors[state.themeColorIndex];

                // Determine if the theme's background is ACTUALLY dark right now
                let isActualDark = t.isCardDark;
                if (state.themeColorIndex === 0) { // Void theme
                    isActualDark = (state.globalTheme === 'dark');
                } else if (state.themeColorIndex === 4) { // Midnight theme
                    isActualDark = true;
                }

                // Adaptive properties based on actual darkness
                // Adaptive properties based on actual darkness
                document.body.setAttribute('data-theme-context', isActualDark ? 'dark' : 'light');

                const activeUiBg = isActualDark ? 'bg-white/5' : 'bg-black/5';
                const activeUiBorder = isActualDark ? 'border-white/5' : 'border-black/5';
                const activeHover = isActualDark ? 'hover:bg-white/10' : 'hover:bg-black/10';
                const activeTextMain = isActualDark ? 'text-white' : 'text-black';
                const activeTextDim = isActualDark ? 'text-white/50' : 'text-black/50';
                const activeHoverIcon = isActualDark ? 'hover:text-white/80' : 'hover:text-black/80';

                const uiNodes = [
                    document.getElementById('ui-btn-back'),
                    document.getElementById('ctrl-font-container'),
                    document.getElementById('ctrl-theme-container'),
                    document.getElementById('ctrl-family-container')
                ];

                const iconNodes = [
                    document.getElementById('ui-icon-font'),
                    document.getElementById('ui-icon-theme'),
                    document.getElementById('ui-icon-family')
                ];

                const textNodes = [
                    document.getElementById('ui-text-project'),
                    document.getElementById('burn-area'),
                    ...document.querySelectorAll('#view-burn h1, #view-burn h1 span, #view-burn p')
                ];

                const dimNodes = [
                    document.getElementById('ui-text-release'),
                    document.getElementById('ui-text-footer'),
                    document.getElementById('audio-status')
                ];

                const accentNodes = [
                    document.getElementById('audio-timer')
                ];

                // 1. Buttons & Containers
                uiNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('bg-white/5', 'bg-black/5', 'border-white/5', 'border-black/5', 'text-white', 'text-black', 'hover:bg-white/10', 'hover:bg-black/10', 'bg-text-light/5', 'border-text-light/5');
                    el.classList.add(activeUiBg, activeUiBorder, activeHover);
                });

                // 2. Control Icons
                iconNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white/50', 'text-black/50', 'hover:text-white/80', 'hover:text-black/80');
                    el.classList.add(activeTextDim, activeHoverIcon);
                });

                // 3. Main UI Text
                textNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white', 'text-black', 'text-text-light', '!text-white', '!text-gray-900', '!text-gray-200');
                    el.classList.add(activeTextMain);
                    // Force high contrast for headings, paragraphs, and textareas
                    if (el.tagName === 'H1' || el.tagName === 'P' || el.tagName === 'SPAN' || el.tagName === 'TEXTAREA') {
                        el.style.color = isActualDark ? 'rgba(255,255,255,0.95)' : 'rgba(0,0,0,0.95)';
                        // Handle shiny tagline gradient override
                        if (el.id === 'shiny-tagline-burn') {
                            if (isActualDark) {
                                el.style.background = `linear-gradient(-35deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.95) 40%, var(--nexus-orange) 50%, rgba(255,255,255,0.95) 60%, rgba(255,255,255,0.95) 100%)`;
                            } else {
                                el.style.background = `linear-gradient(-35deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.95) 40%, var(--nexus-orange) 50%, rgba(0,0,0,0.95) 60%, rgba(0,0,0,0.95) 100%)`;
                            }
                            el.style.backgroundSize = '400% auto';
                            el.style.webkitBackgroundClip = 'text';
                            el.style.backgroundClip = 'text';
                        }
                    }
                });

                // 4. Dim UI Text
                dimNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white/50', 'text-black/50', 'text-text-light/50');
                    el.classList.add(activeTextDim);
                });

                // 5. Accent UI Text (Timer)
                accentNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white', 'text-black', 'text-text-light', 'text-white/50', 'text-black/50');
                    el.classList.add(activeTextMain);
                    // Slight dim for timer but still high contrast
                    el.style.opacity = '0.8';
                });

                // 5. Placeholder & Selection Dynamic Style
                let styleEl = document.getElementById('dynamic-theme-style');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'dynamic-theme-style';
                    document.head.appendChild(styleEl);
                }

                // If theme index is 0 (Void), placeholder darkness follows global theme
                const isDark = isActualDark;
                const phColor = isDark ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.1)';
                const phStroke = isDark ? '1px rgba(255, 255, 255, 0.3)' : '1px rgba(0, 0, 0, 0.5)';
                const selectionBg = isDark ? 'rgba(255, 69, 0, 0.3)' : 'rgba(255, 69, 0, 0.2)';
                const shinyBase = '#fff';

                styleEl.textContent = `
                    #burn-area::placeholder {
                        color: ${phColor};
                        opacity: 0.8;
                        font-weight: 300;
                    }
                    ::selection {
                        background: ${selectionBg};
                    }
                    .active-theme-ring {
                        box-shadow: 0 0 0 2px var(--nexus-orange);
                        transform: scale(1.2);
                    }
                `;

                // 6. Highlight active theme button
                const themeContainer = document.getElementById('ctrl-theme');
                if (themeContainer) {
                    themeContainer.querySelectorAll('button').forEach((btn, idx) => {
                        if (idx === state.themeColorIndex) {
                            btn.classList.add('active-theme-ring');
                        } else {
                            btn.classList.remove('active-theme-ring');
                        }
                    });
                }

                // 7. Adaptive colors for Mode Toggles
                const modeToggles = [
                    document.getElementById('ui-btn-mode'),
                    document.getElementById('ui-btn-haptic')
                ];
                modeToggles.forEach(btn => {
                    if (!btn) return;
                    // Force high contrast: 85% opacity text and 25% opacity border
                    btn.style.color = isActualDark ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.85)';
                    btn.classList.remove('border-white/5', 'border-black/5', 'border-white/20', 'border-black/20');
                    btn.style.borderColor = isActualDark ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.25)';
                });

                // Style Audio Play Control - Standard Grey
                const playBtn = document.getElementById('btn-play-audio');
                if (playBtn) {
                    playBtn.style.backgroundColor = isActualDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                    playBtn.style.borderColor = isActualDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)';
                    const playIcon = playBtn.querySelector('i');
                    if (playIcon) {
                        playIcon.style.color = isActualDark ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.85)';
                    }
                }

                track(`Theme Color Changed`);
            }

            // Export to window for HTML onclicks
            window.navigate = navigate;
            window.performBurn = performBurn;
            window.resetMode = resetMode;
            window.triggerHammer = triggerHammer;
            window.toggleMode = toggleMode;
            window.toggleRecording = toggleRecording;
            window.finishCalm = finishCalm;
            window.toggleWaitlist = toggleWaitlist;
            window.shareLink = shareLink;
            window.changeTextSize = changeTextSize;
            window.changeThemeColor = changeThemeColor;
            window.toggleControl = toggleControl;

            function toggleGlobalTheme() {
                state.globalTheme = state.globalTheme === 'dark' ? 'light' : 'dark';
                applyGlobalTheme();
                localStorage.setItem('release-theme', state.globalTheme);
                track(`Global Theme Toggled: ${state.globalTheme}`);
            }
            window.toggleGlobalTheme = toggleGlobalTheme;

            function applyGlobalTheme() {
                const body = document.body;
                const icon = document.getElementById('theme-icon');
                const burnCanvas = document.getElementById('burn-canvas');

                if (state.globalTheme === 'light') {
                    body.classList.add('light-theme');
                    if (icon) {
                        icon.classList.remove('fa-moon');
                        icon.classList.add('fa-sun');
                    }
                    // Ensure burn canvas is shown if on burn page (for scrape effect)
                    if (burnCanvas) burnCanvas.style.display = (state.view === 'burn') ? 'block' : 'none';
                } else {
                    body.classList.remove('light-theme');
                    if (icon) {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                    }
                    // Ensure burn canvas is shown immediately if not light theme AND on burn page
                    if (burnCanvas) {
                        burnCanvas.style.display = (state.view === 'burn') ? 'block' : 'none';
                    }
                }

                const isLight = state.globalTheme === 'light';
                document.documentElement.classList.toggle('light-theme', isLight);
                document.documentElement.classList.toggle('dark-theme', !isLight);

                const themeColor = isLight ? '#f8f9fa' : '#050505';

                // Update Marketing Card Colors if visible
                const beam = document.getElementById('marketing-beam');
                const inner = document.getElementById('marketing-pill-inner');
                const emailInput = document.getElementById('waitlist-email-inline');
                if (beam && inner && emailInput) {
                    if (state.globalTheme === 'dark') {
                        // Dark Mode: Swap white border with orange, and orange beam with yellowish
                        beam.style.background = 'conic-gradient(from 0deg, transparent 0%, #ffcc00 10%, transparent 20%)'; // Yellowish
                        inner.style.borderColor = '#ff6633'; // Orange border
                        inner.classList.replace('bg-white', 'bg-black/80');
                        inner.classList.add('backdrop-blur-xl');

                        emailInput.classList.replace('text-black', 'text-white');
                        emailInput.classList.remove('placeholder:text-black/40');
                        emailInput.classList.add('placeholder:text-white/40');
                    } else {
                        // Light Mode: Default colors
                        beam.style.background = 'conic-gradient(from 0deg, transparent 0%, #ff6633 10%, transparent 20%)'; // Orange
                        inner.style.borderColor = 'rgba(255,255,255,0.05)';
                        inner.classList.replace('bg-black/80', 'bg-white');
                        inner.classList.remove('backdrop-blur-xl');

                        emailInput.classList.replace('text-white', 'text-black');
                        emailInput.classList.remove('placeholder:text-white/40');
                        emailInput.classList.add('placeholder:text-black/40');
                    }
                }

                // Ash It Flash Fix: Reset intensity instantly to avoid flash/fade-in transitions
                const isFireActive = state.globalTheme === 'dark' && state.fireAnimationEnabled;
                state.visualIntensity = isFireActive ? Math.pow(0.9, state.burnCount) : 0.0;

                if (state.view === 'burn' && !state.isSubmittingBurn) {
                    renderAtmos();
                }

                const metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) metaTheme.setAttribute('content', themeColor);

                // Refresh Ash page theme if it exists
                if (typeof changeThemeColor === 'function') changeThemeColor(state.themeColorIndex);
            }
            window.applyGlobalTheme = applyGlobalTheme;

            function setMainButtonStyle(style) {
                const btn = document.getElementById('btn-main-action');
                if (!btn) return;
                if (style === 'secondary') {
                    btn.classList.add('glass-card', 'btn-secondary', 'opacity-50', 'bg-white/10', 'hover:bg-white/20');
                    btn.classList.remove('bg-nexus-orange', 'text-white', 'shadow-[0_0_30px_rgba(255,68,0,0.3)]', 'hover:shadow-[0_0_50px_rgba(255,68,0,0.5)]', 'text-black', 'text-white/80', 'text-black/80');
                } else {
                    btn.classList.remove('glass-card', 'opacity-50', 'btn-secondary', 'bg-white/10', 'hover:bg-white/20');
                    // Text color is explicitly white for primary orange button
                    btn.classList.add('bg-nexus-orange', 'text-white', 'shadow-[0_0_30px_rgba(255,68,0,0.3)]', 'hover:shadow-[0_0_50px_rgba(255,68,0,0.5)]');
                }
            }
            window.setMainButtonStyle = setMainButtonStyle;

            const area = document.getElementById('burn-area');
            area.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    handleMainAction();
                }
            });

            const mainBtn = document.getElementById('btn-main-action');

            function updateMainButtonOpacity(isHover = false) {
                if (state.mode === 'audio') {
                    setMainButtonStyle('primary');
                    mainBtn.style.opacity = '1';
                    mainBtn.style.pointerEvents = 'auto';
                    mainBtn.disabled = false;
                    return;
                }

                const hasText = area.value.trim().length > 0;

                if (hasText) {
                    setMainButtonStyle('primary');
                    mainBtn.style.pointerEvents = 'auto';
                    mainBtn.disabled = false;
                } else {
                    setMainButtonStyle('secondary');
                    mainBtn.style.pointerEvents = 'none';
                    mainBtn.disabled = true;
                }
            }

            area.addEventListener('input', () => updateMainButtonOpacity());
            mainBtn.addEventListener('mouseenter', () => updateMainButtonOpacity(true));
            mainBtn.addEventListener('mouseleave', () => updateMainButtonOpacity(false));

            // Initialize Opacity
            updateMainButtonOpacity();
            window.updateMainButtonOpacity = updateMainButtonOpacity;

            // Initialize Theme
            // Initial Themes
            changeThemeColor(state.themeColorIndex);
            changeTextSize(1);
            applyGlobalTheme(); // Ensure UI state matches stored theme
            navigate('home');

            // Attach to window for HTML access
            window.navigate = navigate;
            window.handleMainAction = handleMainAction;
            window.toggleRecording = toggleRecording;
            window.toggleControl = toggleControl;
            window.changeThemeColor = changeThemeColor;
            window.changeTextSize = changeTextSize;
            window.changeFontFamily = changeFontFamily;
            window.shareLink = shareLink;
            window.toggleWaitlist = toggleWaitlist;
            window.submitInlineWaitlist = submitInlineWaitlist;
            window.performBurn = performBurn;
            window.resetMode = resetMode;
            window.stopRecording = stopRecording;
            window.state = state;

            // --- FEEDBACK LOGIC ---
            const stateRatings = { ash: 0, air: 0 };

            function toggleFeedbackModal(show) {
                const modal = document.getElementById('feedback-modal');
                const content = document.getElementById('feedback-modal-content');
                if (show) {
                    modal.classList.remove('hidden');
                    // Force reflow
                    void modal.offsetWidth;
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                } else {
                    modal.classList.add('opacity-0');
                    content.classList.remove('scale-100', 'opacity-100');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                }
            }
            window.toggleFeedbackModal = toggleFeedbackModal;

            function setRating(tool, value) {
                stateRatings[tool] = value;
                const stars = document.querySelectorAll(`#rating-${tool} i`);
                const activeColor = tool === 'ash' ? 'text-nexus-orange' : 'text-calm-blue';
                const inactiveColor = tool === 'ash' ? 'text-white/20' : 'text-black/10';

                stars.forEach((star, index) => {
                    if (index < value) {
                        star.classList.remove(inactiveColor);
                        star.classList.add(activeColor);
                        star.style.textShadow = `0 0 10px var(--${tool === 'ash' ? 'nexus-orange' : 'calm-blue'})`;
                        star.classList.add('scale-110');
                    } else {
                        star.classList.remove(activeColor, 'scale-110');
                        star.classList.add(inactiveColor);
                        star.style.textShadow = 'none';
                    }
                });
            }
            window.setRating = setRating;

            // -- GOOGLE SHEETS SETUP --
            // Replace this URL with your custom Google Apps Script Web App URL
            const GOOGLE_SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwmNf40Qhoyg5Izs8fZ8XeAU6heN6NkIkYgqkcY7Bk6YromeJeMIrvDgGVtf2tLpzWT/exec";

            function submitFeedback() {
                const btn = document.getElementById('btn-submit-feedback');
                const msg = document.getElementById('feedback-success-msg');
                const text = document.getElementById('feedback-text').value;

                btn.innerText = "Sending...";
                btn.style.opacity = 0.5;
                btn.disabled = true;

                // Create a FormData object to send to Apps Script
                const formData = new FormData();
                formData.append('date', new Date().toISOString());
                formData.append('ash_rating', stateRatings['ash']);
                formData.append('air_rating', stateRatings['air']);
                formData.append('feedback_text', text);

                // Send silently in background
                fetch(GOOGLE_SHEETS_WEBAPP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Bypasses CORS issues
                    body: formData
                }).then(() => {
                    // Show success
                    btn.classList.add('hidden');
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.remove('opacity-0'), 10);

                    // We no longer auto-close the modal so they can click the Waitlist button
                    // But we still reset the form state secretly in the background after 5 seconds just in case they reopen it later
                    setTimeout(() => {
                        setRating('ash', 0);
                        setRating('air', 0);
                        document.getElementById('feedback-text').value = '';
                        btn.classList.remove('hidden');
                        btn.innerText = "Send Feedback";
                        btn.style.opacity = 1;
                        btn.disabled = false;
                        msg.classList.add('opacity-0', 'hidden');
                    }, 10000); // Reset behind the scenes after 10 seconds
                }).catch(error => {
                    console.error("Error submitting feedback:", error);
                    // Reset on error so they can try again
                    btn.innerText = "Send Feedback";
                    btn.style.opacity = 1;
                    btn.disabled = false;
                });
            }
            window.submitFeedback = submitFeedback;

            // --- END CORE ---

            function toggleFireAnimation() {
                state.fireAnimationEnabled = !state.fireAnimationEnabled;
                localStorage.setItem('fire-animation-enabled', state.fireAnimationEnabled);
                updateFireToggleUI();
                if (state.view === 'burn' && !state.isSubmittingBurn) {
                    renderAtmos();
                }
            }

            function updateFireToggleUI() {
                const btn = document.getElementById('ui-btn-fire');
                const icon = document.getElementById('fire-toggle-icon');
                if (state.fireAnimationEnabled) {
                    btn.classList.remove('opacity-20');
                    btn.classList.add('opacity-100', 'text-nexus-orange');
                    icon.className = 'fa-solid fa-fire-flame-curved text-xs';
                } else {
                    btn.classList.add('opacity-20');
                    btn.classList.remove('opacity-100', 'text-nexus-orange');
                    icon.className = 'fa-solid fa-fire-flame-simple text-xs';
                }
            }

            window.toggleFireAnimation = toggleFireAnimation;

            // Initialize UI states
            document.addEventListener('DOMContentLoaded', () => {
                updateFireToggleUI();
            });
        </script>
        <script src="js/liquid-bg.js"></script>
</body>

</html>