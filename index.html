<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Release • Into the Void</title>

    <!-- PWA & Mobile Optimization -->
    <meta name="theme-color" content="#050505">
    <meta name="msapplication-navbutton-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- UI Frameworks & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nexus-orange': 'var(--nexus-orange)',
                        'calm-blue': 'var(--calm-blue)',
                        'bg-deep': 'var(--bg-deep)',
                        'text-light': 'var(--text-light)',
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'border-beam': 'border-beam 10s linear infinite',
                        'border-rotate': 'border-rotate 4s linear infinite',
                    },
                    keyframes: {
                        'border-beam': {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' },
                        },
                        'border-rotate': {
                            'from': { transform: 'rotate(0deg)' },
                            'to': { transform: 'rotate(360deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="h-screen w-screen selection:bg-orange-500/30">

    <!-- Global Background Elements -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div
            class="absolute top-[10%] left-[50%] -translate-x-1/2 w-[600px] h-[600px] bg-nexus-orange/5 rounded-full blur-[120px]">
        </div>
    </div>

    <!-- Top Bar -->
    <header id="nav-bar"
        class="fixed top-0 left-0 w-full p-6 flex justify-between items-center z-[150] safe-top pointer-events-none">
        <div class="flex items-center gap-2 pointer-events-auto cursor-pointer" onclick="navigate('home')">
            <div class="w-1 h-1 bg-nexus-orange rounded-full"></div>
            <h1 class="text-xs font-black uppercase tracking-[0.4em] opacity-80">Release</h1>
        </div>
        <div class="flex items-center gap-4 pointer-events-auto">
            <button type="button" onclick="toggleGlobalTheme()" aria-label="Toggle Theme" title="Toggle Theme"
                id="ui-btn-theme"
                class="w-10 h-10 flex items-center justify-center transition-all cursor-pointer relative z-[200] opacity-50 hover:opacity-100 shadow-sm">
                <i id="theme-icon" class="fa-solid fa-moon text-xs"></i>
            </button>
            <button type="button" onclick="toggleWaitlist(true)"
                class="waitlist-radial text-white px-2 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.2em] hover:scale-105 active:scale-95 transition-all cursor-pointer relative z-[200] shadow-[0_2px_10px_rgba(255,68,0,0.2)] hover:shadow-[0_4px_15px_rgba(255,68,0,0.4)] overflow-hidden shiny-button-fix w-24">
                <div class="marquee-container">
                    <div class="marquee-content">
                        <span>Waitlist • Waitlist • Waitlist • Waitlist • </span>
                    </div>
                </div>
            </button>
            <button type="button" onclick="shareLink()" aria-label="Share" title="Share" id="ui-btn-share"
                class="w-10 h-10 flex items-center justify-center glass-card border border-white/10 rounded-full hover:bg-white/10 transition-all cursor-pointer relative z-[200] shadow-[0_2px_8px_rgba(0,0,0,0.15)]">
                <i class="fa-solid fa-arrow-up-from-bracket text-xs text-light"></i>
            </button>
        </div>
    </header>

    <!-- Main View Switcher -->
    <main class="relative w-full h-full z-10">

        <!-- VIEW: HOME -->
        <section id="view-home" class="view-container active">
            <div class="aurora-wrapper">
                <div class="aurora-container"></div>
                <div class="aurora-noise"></div>
                <div class="aurora-overlay"></div>
            </div>
            <!-- Hero Background Media (Atmospheric Image) -->
            <div class="hero-bg-media">
                <canvas id="bg-canvas"></canvas>
            </div>

            <div class="scroll-wrapper items-center justify-center px-6 relative z-10">
                <div class="w-full max-w-2xl text-left my-auto py-12 px-2">
                    <p class="text-[10px] uppercase tracking-[0.5em] text-nexus-orange font-black mb-4">The Void</p>
                    <h1 class="text-[clamp(1.5rem,6vw,3.5rem)] font-thin tracking-tight leading-tight mb-6">Vent <span
                            id="hyper-text-home">anxiety, anger, panic</span> <span id="shiny-tagline-home"
                            class="text-shiny-orange font-black">without judgment.</span>
                    </h1>
                    <p class="text-sm text-text-light/50 font-light leading-relaxed max-w-xl mb-12">Catch the wave
                        before it
                        spills over. Release it all here. A new way to be heard is on the horizon. Join the waitlist to
                        be notified.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 w-full max-w-5xl mx-auto">
                        <!-- Mode 01: Ash It -->
                        <button type="button" onclick="navigate('burn')"
                            class="group relative h-32 white-glass-card rounded-[32px] p-6 text-left transition-all duration-150 hover:scale-[1.02] active:scale-[0.98] hover-glow-orange">
                            <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none">
                                <div class="shine-effect"></div>
                                <div class="absolute right-0 top-0 p-8">
                                    <i class="fa-solid fa-fire text-6xl glass-icon-white"></i>
                                </div>
                            </div>
                            <div
                                class="relative z-10 h-full flex flex-col justify-between transition-transform duration-150 group-hover:translate-x-1">
                                <div class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-nexus-orange animate-pulse"></span>
                                    <span class="font-bold uppercase tracking-widest text-[10px] opacity-80">Mode
                                        01</span>
                                </div>
                                <div>
                                    <h3
                                        class="text-xl font-light tracking-tight group-hover:font-normal transition-all">
                                        Ash It</h3>
                                    <p class="text-[9px] uppercase tracking-widest opacity-40 mt-1">Anxiety • Worry •
                                        Thoughts</p>
                                </div>
                            </div>
                        </button>

                        <!-- Mode 02: Calm It -->
                        <button type="button" onclick="navigate('calm')"
                            class="group relative h-32 white-glass-card rounded-[32px] p-6 text-left transition-all duration-150 hover:scale-[1.02] active:scale-[0.98] hover-glow-blue">
                            <!-- Inner clipping container for shine and icons -->
                            <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none">
                                <div class="shine-effect"></div>
                                <div
                                    class="absolute right-0 top-0 p-8 opacity-100 group-hover:opacity-100 transition-all duration-200">
                                    <i class="fa-solid fa-wind text-6xl glass-icon-white"></i>
                                </div>
                            </div>
                            <div
                                class="relative z-10 h-full flex flex-col justify-between transition-transform duration-150 group-hover:translate-x-1">
                                <div class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-calm-blue animate-pulse"></span>
                                    <span class="font-bold uppercase tracking-widest text-[10px] text-calm-blue/80">Mode
                                        02</span>
                                </div>
                                <div>
                                    <h3
                                        class="text-xl font-light tracking-tight group-hover:font-normal transition-all">
                                        Air It</h3>
                                    <p class="text-[9px] uppercase tracking-widest opacity-40 mt-1">Breath • Focus •
                                        Peace</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="w-full max-w-5xl py-12 text-center relative z-10 mx-auto mt-auto">
                    <p class="text-[9px] uppercase tracking-[0.4em] text-light opacity-30 font-bold italic mb-2">For
                        relaxing/venting only. Not medical advice.</p>
                    <p class="text-[9px] uppercase tracking-[0.6em] text-light opacity-50 font-black">NO RECORDS • NO
                        ALGORITHMS | Release | A Nexus Project</p>
                </div>
            </div>
        </section>

        <!-- VIEW: ASH -->
        <section id="view-burn" class="view-container">

            <div class="scroll-wrapper items-center pt-8 px-4 md:px-8 pb-6">

                <div class="w-full max-w-5xl flex items-start gap-4 mb-8 relative z-10 px-0 mx-auto">
                    <button onclick="navigate('home')" aria-label="Back"
                        class="mt-1 text-light opacity-20 hover:opacity-100 transition-colors cursor-pointer active:scale-95">
                        <i class="fa-solid fa-chevron-left text-sm"></i>
                    </button>
                    <div>
                        <p class="mt-[9px] text-[10px] uppercase tracking-[0.5em] text-nexus-orange font-black mb-1">
                            Enter the
                            Void</p>
                        <h1 class="text-[clamp(1.1rem,4.5vw,2.2rem)] font-thin tracking-tight leading-tight mb-2">
                            A sanctuary <span id="hyper-text-burn">for your</span> <span id="shiny-tagline-burn"
                                class="text-shiny-orange font-black">CALM IS COMING...</span>
                        </h1>
                        <p class="text-xs md:text-sm text-text-light/50 font-light leading-relaxed max-w-xl">Release the
                            weight
                            before it breaks you. No judgment. No records. Just release.</p>
                    </div>
                </div>

                <div class="flex-0 w-full flex flex-col items-center justify-center p-0 relative z-20">

                    <!-- Editor Controls (Anchored to Top-Right of Card) -->
                    <div
                        class="w-full max-w-5xl flex justify-end gap-3 mb-[10px] px-0 relative z-[70] pointer-events-auto">
                        <!-- Font Control -->
                        <div id="ctrl-font-container" onclick="toggleControl('ctrl-font')"
                            onmouseleave="toggleControl(null)"
                            class="editor-control flex items-center bg-white/5 rounded-full px-3 py-2 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                            <i id="ui-icon-font"
                                class="fa-solid fa-font text-[10px] text-white/50 hover:text-white/80 transition-colors"></i>
                            <div id="ctrl-font"
                                class="w-0 overflow-hidden transition-all duration-500 ease-out flex items-center">
                                <input type="range" min="0" max="3" value="1" step="1"
                                    oninput="changeTextSize(this.value)" onclick="event.stopPropagation()"
                                    aria-label="Text Size"
                                    class="w-24 h-1 ml-4 bg-white/10 rounded-lg appearance-none cursor-pointer accent-nexus-orange">
                            </div>
                        </div>
                        <!-- Theme Control -->
                        <div id="ctrl-theme-container" onclick="toggleControl('ctrl-theme')"
                            onmouseleave="toggleControl(null)"
                            class="editor-control flex items-center bg-white/5 rounded-full px-3 py-2 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                            <i id="ui-icon-theme"
                                class="fa-solid fa-palette text-xs text-white/50 hover:text-white/80 transition-colors"></i>
                            <div id="ctrl-theme"
                                class="w-0 overflow-hidden transition-all duration-500 ease-out flex items-center gap-2 pl-0">
                                <!-- Black (Default) -->
                                <button onclick="changeThemeColor(0); event.stopPropagation()"
                                    class="w-4 h-4 rounded-full bg-[var(--bg-deep)] border border-white/20 hover:scale-125 transition-transform"
                                    title="Void"></button>
                                <!-- Ivory -->
                                <button onclick="changeThemeColor(1); event.stopPropagation()"
                                    class="w-4 h-4 rounded-full bg-[#fff3e0] border border-white/10 hover:scale-125 transition-transform"
                                    title="Ivory"></button>
                                <!-- Mist -->
                                <button onclick="changeThemeColor(2); event.stopPropagation()"
                                    class="w-4 h-4 rounded-full bg-[#e5f3f8] border border-white/10 hover:scale-125 transition-transform"
                                    title="Mist"></button>
                                <!-- Pewter -->
                                <button onclick="changeThemeColor(3); event.stopPropagation()"
                                    class="w-4 h-4 rounded-full bg-[#dadecf] border border-white/10 hover:scale-125 transition-transform"
                                    title="Pewter"></button>
                                <!-- Midnight -->
                                <button onclick="changeThemeColor(4); event.stopPropagation()"
                                    class="w-4 h-4 rounded-full bg-[#191738] border border-white/10 hover:scale-125 transition-transform"
                                    title="Midnight"></button>
                            </div>
                        </div>
                        <!-- Mobile Haptic Toggle (Icon Only) -->
                        <div id="ctrl-haptic-mobile" onclick="toggleHaptics()"
                            class="editor-control hidden md:hidden items-center bg-white/5 rounded-full px-4 py-2 border border-white/5 backdrop-blur-md transition-all duration-300 hover:bg-white/10 cursor-pointer">
                            <i class="fa-solid fa-vibration text-xs text-white/50"></i>
                        </div>
                    </div>

                    <div id="editor-card"
                        class="relative w-full max-w-5xl h-[45vh] md:h-[55vh] glass-card rounded-[40px] flex items-center justify-center p-6 transition-all duration-500 group/editor shadow-card-elevated overflow-hidden border-white/5 z-50">



                        <textarea id="burn-area" oninput="updateButtonState()"
                            class="relative z-10 w-full h-full text-left text-xl md:text-3xl font-light bg-transparent border-none outline-none resize-none placeholder-text-light/10 leading-relaxed transition-opacity duration-300"
                            placeholder="Ash whatever's weighing you down"></textarea>

                        <!-- Mode Toggles (Bottom Right) -->
                        <div class="absolute bottom-4 right-4 flex items-center gap-3 z-30 pointer-events-auto">
                            <button id="ui-btn-mode" onclick="toggleMode()" aria-label="Toggle Voice Mode"
                                class="h-10 px-4 flex items-center justify-center gap-2 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black uppercase tracking-[0.1em] opacity-70 hover:opacity-100 transition-all cursor-pointer shadow-[0_2px_8px_rgba(255,68,0,0.1)] hover:shadow-[0_4px_12px_rgba(255,68,0,0.2)]">
                                <i class="fa-solid fa-microphone"></i>
                                <span>Voice</span>
                            </button>
                            <button id="ui-btn-haptic" onclick="toggleHaptics()" aria-label="Toggle Haptics"
                                class="md:hidden h-10 px-4 flex items-center justify-center gap-2 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black uppercase tracking-[0.1em] opacity-70 hover:opacity-100 transition-all cursor-pointer shadow-[0_2px_8px_rgba(255,68,0,0.1)] hover:shadow-[0_4px_12px_rgba(255,68,0,0.2)]">
                                <i class="fa-solid fa-vibration"></i>
                                <span>Haptic</span>
                            </button>
                        </div>

                        <!-- Audio Recorder Interface -->
                        <div id="audio-wrapper"
                            class="absolute inset-0 z-20 flex flex-col items-center justify-center p-8 hidden pointer-events-none opacity-0 transition-opacity duration-300">
                            <canvas id="audio-visualizer" class="w-full h-32 mb-8 opacity-80"></canvas>

                            <div class="flex items-center justify-center pointer-events-auto relative">
                                <!-- Playback (Hidden initially) -->
                                <button id="btn-play-audio" onclick="togglePlayback()" aria-label="Play Recording"
                                    class="hidden w-20 h-20 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all relative z-20 cursor-pointer border border-white/10">
                                    <i class="fa-solid fa-play text-white text-2xl translate-x-1"></i>
                                </button>
                            </div>

                            <div class="flex flex-col items-center mt-6 gap-2">
                                <p id="audio-timer" class="text-4xl font-mono text-white/50 font-light tracking-widest">
                                    00:00</p>
                                <p id="audio-status" class="text-[10px] uppercase tracking-[0.3em] opacity-40">Tap to
                                    Record
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="burn-action"
                    class="w-full max-w-5xl px-0 py-4 mx-auto transition-all duration-700 relative z-10">
                    <button type="button" onclick="handleMainAction()" id="btn-main-action"
                        class="w-full h-14 rounded-[40px] uppercase tracking-[0.4em] text-base active:scale-95 transition-all glass-card text-text-light/20 flex items-center justify-center">
                        <span>Ash It</span>
                        <kbd
                            class="ml-2 opacity-50 text-[11px] border border-white/20 px-1.5 py-0.5 rounded font-medium lowercase pointer-events-none tracking-normal">Ctrl+Enter</kbd>
                    </button>
                </div>

                <!-- Marketing Card (Hidden) -->
                <div id="burn-marketing"
                    class="hidden w-full max-w-5xl pt-0 mx-auto animate-fly-top relative z-10 px-0">
                    <div
                        class="white-glass-card rounded-[40px] p-4 text-center space-y-4 relative overflow-hidden border-none">
                        <!-- Card Background Image -->
                        <div class="absolute inset-0 z-0 pointer-events-none opacity-[0.28]">
                            <img src="index/waitlist.jpg" alt="" class="w-full h-full object-cover">
                        </div>
                        <div class="relative z-10 space-y-4 p-4">
                            <p class="text-sm opacity-80 font-light leading-relaxed">That thought is gone. If the weight
                                remains, a Nexus Sentinel is listening.</p>
                            <div class="relative w-full max-w-2xl mx-auto group/pill animate-fade">
                                <!-- Perimeter Beam Border Mask -->
                                <div class="relative p-[1px] rounded-full overflow-hidden shadow-2xl">
                                    <!-- Rotating Beam -->
                                    <div class="absolute inset-[-150%] animate-border-rotate opacity-80"
                                        style="background: conic-gradient(from 0deg, transparent 0%, #ff6633 10%, transparent 20%);">
                                    </div>

                                    <!-- Inner Content -->
                                    <div
                                        class="bg-white rounded-full p-1.5 flex items-center relative z-10 border border-white/5">
                                        <input type="email" id="waitlist-email-inline" placeholder="Enter your email"
                                            class="flex-1 bg-transparent px-8 py-3.5 text-sm font-light tracking-wide focus:outline-none text-black placeholder:text-black/40 border-none outline-none">
                                        <button type="button" onclick="submitInlineWaitlist()"
                                            class="group/waitlist-btn bg-black text-white px-8 py-3.5 rounded-full text-base transition-all hover:bg-zinc-900 active:scale-[0.97] flex items-center gap-0 hover:gap-3">
                                            <span class="whitespace-nowrap">Join Waitlist</span>
                                            <i
                                                class="fa-solid fa-arrow-right opacity-0 w-0 group-hover/waitlist-btn:opacity-100 group-hover/waitlist-btn:w-auto transition-all duration-300 text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div id="ash-footer" class="w-full max-w-5xl py-12 text-center relative z-10 mx-auto">
                    <p id="ui-text-footer"
                        class="text-[9px] uppercase tracking-[0.4em] text-light opacity-30 font-bold italic mb-2">
                        For
                        relaxing/venting only. Not medical advice.</p>
                    <p class="text-[9px] uppercase tracking-[0.6em] text-light opacity-50 font-black">NO RECORDS •
                        NO
                        ALGORITHMS | Release | A Nexus Project</p>
                </div>
            </div>
            </div>
        </section>

        <!-- VIEW: SMASH -->
        <section id="view-smash" class="view-container" onclick="triggerHammer(event)">

            <div class="scroll-wrapper items-center justify-center bg-transparent overflow-hidden">
                <div id="smash-overlay"
                    class="absolute inset-0 z-10 pointer-events-none transition-opacity duration-300">
                </div>

                <div class="relative z-0 text-center pointer-events-none">
                    <h3 class="text-sm font-thin tracking-[1em] opacity-20 uppercase">Surface</h3>
                    <p id="smash-hint" class="text-[9px] uppercase tracking-widest opacity-10 mt-2">Tap repeatedly to
                        release energy</p>
                </div>

                <!-- Marketing Card (Hidden) -->
                <div id="smash-marketing"
                    class="hidden absolute inset-0 z-30 bg-black/90 backdrop-blur-2xl flex flex-col items-center justify-center p-8 text-center">
                    <div class="max-w-xs space-y-8">
                        <i class="fa-solid fa-hammer text-3xl opacity-20"></i>
                        <p class="text-lg font-light italic leading-relaxed">Violence releases energy, not pain. Talk it
                            out
                            on Nexus.</p>
                        <button type="button" onclick="toggleWaitlist(true)"
                            class="bg-white text-black px-10 py-4 rounded-full font-black uppercase text-[10px] tracking-[0.2em]">Join
                            Waitlist</button>
                        <button type="button" onclick="resetMode('smash')"
                            class="text-nexus-orange text-[10px] font-black uppercase tracking-[0.2em]">Repair
                            Screen</button>
                    </div>
                </div>
                <div class="w-full max-w-5xl py-12 text-center relative z-10 mx-auto">
                    <p class="text-[9px] uppercase tracking-[0.4em] text-light opacity-30 font-bold italic mb-2">For
                        relaxing/venting only. Not medical advice.</p>
                    <p class="text-[9px] uppercase tracking-[0.6em] text-light opacity-50 font-black">NO RECORDS • NO
                        ALGORITHMS | Release | A Nexus Project</p>
                </div>
            </div>
        </section>

        <!-- VIEW: CALM -->
        <section id="view-calm" class="view-container flex-col">

            <div class="scroll-wrapper items-center justify-center p-6">
                <div class="flex-1 w-full flex flex-col items-center justify-center min-h-[80vh]">
                    <div class="relative w-48 h-48 flex items-center justify-center">
                        <div class="absolute inset-0 rounded-full border border-calm-blue/30 breathing-core"></div>
                        <div class="absolute inset-4 rounded-full bg-calm-blue/5 backdrop-blur-3xl animate-pulse"></div>
                        <div class="relative z-10 flex flex-col items-center">
                            <span id="calm-timer-countdown"
                                class="text-4xl font-thin tracking-tighter mb-1 select-none"></span>
                            <span id="breathing-txt"
                                class="text-[10px] font-black uppercase tracking-[0.5em] pl-[0.5em] text-calm-blue transition-all duration-1000 select-none">Inhale</span>
                        </div>
                    </div>
                </div>

                <!-- Timer Settings -->
                <div class="w-full max-w-xs flex flex-col items-center gap-4 mb-20 opacity-60">
                    <p class="text-[9px] uppercase tracking-[0.4em] font-black opacity-30">Pace</p>
                    <div class="flex items-center gap-8">
                        <button onclick="adjustCalmTime(-1)"
                            class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center hover:bg-white/5 active:scale-90 transition-all">
                            <i class="fa-solid fa-minus text-[10px]"></i>
                        </button>
                        <div class="text-center">
                            <span id="calm-time-display" class="text-2xl font-thin tracking-tighter">4</span>
                            <span class="text-[10px] uppercase tracking-widest opacity-30 ml-1">sec</span>
                        </div>
                        <button onclick="adjustCalmTime(1)"
                            class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center hover:bg-white/5 active:scale-90 transition-all">
                            <i class="fa-solid fa-plus text-[10px]"></i>
                        </button>
                    </div>
                </div>

                <div id="calm-action" class="w-full max-w-sm pb-12">
                    <button type="button" onclick="finishCalm()"
                        class="w-full border border-calm-blue/40 text-calm-blue h-16 rounded-3xl font-black uppercase tracking-[0.4em] text-[10px] active:bg-calm-blue/10 transition-colors">
                        I feel grounded
                    </button>
                </div>

                <!-- Footer -->
                <div class="w-full max-w-5xl py-12 text-center relative z-10 mx-auto mt-auto">
                    <p class="text-[9px] uppercase tracking-[0.4em] text-light opacity-30 font-bold italic mb-2">For
                        relaxing/venting
                        only. Not medical advice.</p>
                    <p class="text-[9px] uppercase tracking-[0.6em] text-light opacity-50 font-black">NO RECORDS • NO
                        ALGORITHMS | Release | A Nexus Project</p>
                </div>

                <!-- Marketing Card (Hidden) -->
                <div id="calm-marketing"
                    class="hidden absolute inset-0 z-30 bg-black/90 backdrop-blur-2xl flex flex-col items-center justify-center p-8 text-center">
                    <div class="max-w-xs space-y-12 animate-slide">
                        <p class="text-2xl font-thin italic text-calm-blue leading-tight">Hold onto this <span
                                class="font-bold underline underline-offset-8">peace.</span></p>
                        <div class="space-y-4">
                            <p class="text-[10px] tracking-widest uppercase opacity-40 font-light">Find deep connection
                                on
                                Nexus.</p>
                            <button type="button" onclick="toggleWaitlist(true)"
                                class="text-nexus-orange text-[10px] font-black uppercase tracking-[0.2em] underline underline-offset-8">Join
                                Nexus Waitlist</button>
                        </div>
                        <button type="button" onclick="navigate('home')"
                            class="text-[9px] uppercase tracking-widest opacity-20 hover:opacity-100">Back to the
                            void</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- UI Overlays -->
    <canvas id="burn-canvas" class="fixed inset-0 pointer-events-none z-[3000]"></canvas>



    <!-- Waitlist Modal -->
    <div id="waitlist-modal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/98 backdrop-blur-3xl">
        <div class="w-full max-w-sm glass-card rounded-[48px] p-10 relative overflow-hidden group">
            <div class="absolute -top-20 -right-20 w-40 h-40 bg-nexus-orange/10 blur-3xl rounded-full"></div>
            <button type="button" onclick="toggleWaitlist(false)" aria-label="Close"
                class="absolute top-8 right-10 text-xl opacity-20 hover:opacity-100">&times;</button>

            <div class="relative z-10 text-center">
                <h4 class="text-3xl font-thin tracking-tighter uppercase mb-2">The <span
                        class="text-nexus-orange font-bold">Nexus</span></h4>
                <p class="text-[9px] uppercase tracking-[0.4em] opacity-40 mb-10">Ascend with us.</p>

                <form action="https://formspree.io/f/YOUR_FORM_ID_HERE" method="POST" class="space-y-4">
                    <input type="email" name="email" required placeholder="name@email.com"
                        class="w-full bg-white/[0.03] border border-white/5 rounded-2xl p-5 text-sm outline-none focus:border-nexus-orange transition-all placeholder:opacity-20">
                    <button type="submit" onclick="track('Waitlist Joined')"
                        class="w-full bg-nexus-orange text-white h-14 rounded-2xl uppercase tracking-[0.4em] text-[14px] shadow-2xl shadow-nexus-orange/30">
                        Join Waitlist
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- AUDIO Placeholder (Hidden) -->
    <audio id="crack-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg">
    </audio>

    <script>
        // --- CORE CORE ---
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                view: 'home',
                hits: 0,
                interval: null,
                textSizeIndex: 1, // Default to Small (2nd option)
                themeColorIndex: 0, // Default: White
                mode: 'text', // 'text' or 'audio'
                globalTheme: localStorage.getItem('release-theme') || 'dark',

                // Audio Context & State
                audioBlob: null,
                isRecording: false,
                isPlaying: false,
                mediaRecorder: null,
                audioChunks: [],
                audioContext: null,
                analyser: null,
                source: null,
                visualizerId: null,
                startTime: null,
                timerInterval: null,
                burnComplete: false,
                hapticsEnabled: true,
                globalTheme: localStorage.getItem('release-theme') || 'dark',

                // Calm Mode Config
                calmBaseTime: 4, // Seconds for Inhale/Hold. Exhale is +2.

                // Animation & Particles
                particles: [],
                particleLoopActive: false,
                canvas: document.getElementById('burn-canvas'),
                ctx: document.getElementById('burn-canvas').getContext('2d'),

                // Cached elements for performance
                el: {
                    area: document.getElementById('burn-area'),
                    mainBtn: document.getElementById('btn-main-action'),
                    timer: document.getElementById('audio-timer'),
                    status: document.getElementById('audio-status'),
                    visualizer: document.getElementById('audio-visualizer'),
                    editorCard: document.getElementById('editor-card'),
                    navBar: document.getElementById('nav-bar')
                }
            };


            const textSizes = [
                { class: 'text-lg md:text-2xl', label: 'Tiny' },
                { class: 'text-xl md:text-3xl', label: 'Small' },
                { class: 'text-3xl md:text-5xl', label: 'Medium' }, // Default
                { class: 'text-4xl md:text-6xl', label: 'Large' },
                { class: 'text-5xl md:text-7xl', label: 'Extra' },
                { class: 'text-6xl md:text-8xl', label: 'Huge' }
            ];

            const themeColors = [
                { isCardDark: true, bgClass: 'bg-bg-deep', cardBg: 'bg-text-light/5', textClass: 'text-text-light', dotColor: 'var(--dot-color)', shadowColor: 'rgba(0,0,0,0.05)', uiBg: 'bg-text-light/5', uiBorder: 'border-text-light/5', uiTextMain: 'text-text-light', uiTextDim: 'text-text-light/50' }, // Void
                { isCardDark: false, bgClass: '!bg-[#fff3e0]/80', cardBg: '!bg-[#fff3e0]', textClass: 'text-gray-900', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.1)', uiBg: 'bg-black/5', uiBorder: 'border-black/10', uiTextMain: 'text-black', uiTextDim: 'text-black/50' }, // Ivory
                { isCardDark: false, bgClass: '!bg-[#e5f3f8]/80', cardBg: '!bg-[#e5f3f8]', textClass: 'text-gray-900', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.1)', uiBg: 'bg-black/5', uiBorder: 'border-black/10', uiTextMain: 'text-black', uiTextDim: 'text-black/50' }, // Mist
                { isCardDark: false, bgClass: '!bg-[#dadecf]/80', cardBg: '!bg-[#dadecf]', textClass: 'text-gray-900', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.1)', uiBg: 'bg-black/5', uiBorder: 'border-black/10', uiTextMain: 'text-black', uiTextDim: 'text-black/50' }, // Pewter
                { isCardDark: true, bgClass: '!bg-[#191738]', cardBg: '!bg-white/5', textClass: 'text-gray-200', dotColor: 'rgba(255,255,255,0.15)', shadowColor: 'rgba(0,0,0,0.4)', uiBg: 'bg-white/5', uiBorder: 'border-white/5', uiTextMain: 'text-white', uiTextDim: 'text-white/50' }  // Midnight
            ];


            function track(event) {
                console.log(`[POSTHOG DUMMY] ${event}`);
                // if(typeof posthog !== 'undefined') posthog.capture(event);
            }

            // --- NAVIGATION ---
            function navigate(viewId) {
                document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
                const target = document.getElementById(`view-${viewId}`);
                target.classList.add('active');
                state.view = viewId;

                // Header state - Dim secondary items, keep logo and waitlist bright
                const nav = document.getElementById('nav-bar');
                const navWaitlist = nav.querySelector('button[onclick*="toggleWaitlist"]');
                const navLogo = nav.querySelector('div[onclick*="navigate(\'home\')"]');
                const navShare = nav.querySelector('button[onclick*="shareLink"]');

                if (viewId === 'home') {
                    nav.style.opacity = '1';
                    if (navShare) navShare.style.opacity = '1';
                } else {
                    // Overall header slightly dimmed but important items forced bright
                    nav.style.opacity = '1';
                    if (navLogo) navLogo.style.opacity = '0.6';
                    if (navShare) navShare.style.opacity = '1';
                    // Waitlist button stays 100%
                }

                // Feature Inits
                if (state.view === 'calm' && viewId !== 'calm') {
                    if (state.interval) {
                        clearTimeout(state.interval);
                        state.interval = null;
                    }
                    if (state.timerInterval) {
                        clearInterval(state.timerInterval);
                        state.timerInterval = null;
                    }
                }

                if (viewId === 'calm') runCalmLoop();
                if (viewId === 'burn') setupCanvas();

                track(`App ${viewId.charAt(0).toUpperCase() + viewId.slice(1)} Opened`);
            }

            track('App Opened');

            function setupCanvas() {
                state.canvas.width = window.innerWidth;
                state.canvas.height = window.innerHeight;
            }

            function createParticle(x, y) {
                return {
                    x, y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 1.5) * 4,
                    life: 1.0,
                    size: Math.random() * 4
                };
            }

            function renderParticles() {
                const { canvas, ctx, particles } = state;
                if (particles.length === 0) {
                    state.particleLoopActive = false;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    return;
                }

                state.particleLoopActive = true;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.1; // gravity
                    p.life -= 0.02;

                    if (p.life <= 0) {
                        particles.splice(i, 1);
                        continue;
                    }

                    ctx.fillStyle = `rgba(255, 69, 0, ${p.life})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                }

                requestAnimationFrame(renderParticles);
            }

            function handleMainAction() {
                const area = document.getElementById('burn-area');
                const mainBtn = document.getElementById('btn-main-action');

                // AUDIO MODE
                if (state.mode === 'audio') {
                    // Case 1: Start Recording
                    if (!state.isRecording && !state.audioBlob) {
                        toggleRecording();
                        return;
                    }
                    // Case 2: Stop Recording
                    if (state.isRecording) {
                        stopRecording();
                        return;
                    }
                    // Case 3: Burn It (Recorded)
                    if (state.audioBlob) {
                        performBurn();
                        return;
                    }
                    return;
                }

                // TEXT MODE
                if (state.mode === 'text' && area.value.trim().length > 0) {
                    performBurn();
                    return;
                }
            }
            // Expose to window to ensure HTML onclick can see it
            window.handleMainAction = handleMainAction;

            function performBurn() {
                const area = document.getElementById('burn-area');
                const btn = document.getElementById('btn-main-action');

                // AUDIO MODE BURN
                if (state.mode === 'audio') {
                    if (!state.audioBlob && !state.isRecording) return;

                    track('Audio Ashed');

                    // Visual Glitch Effect on Canvas
                    const canvas = document.getElementById('audio-visualizer');
                    canvas.classList.add('transition-all', 'duration-[1s]', 'blur-xl', 'scale-150', 'opacity-0');

                    state.burnComplete = true;

                    setTimeout(() => {
                        resetMode('burn');
                        const mkt = document.getElementById('burn-marketing');
                        mkt.classList.remove('hidden');

                        // Hide footer to prevent overscroll and visual clutter
                        const footer = document.getElementById('ash-footer');
                        if (footer) footer.classList.add('hidden');

                        // Sync scroll with fly-in
                        const wrapper = mkt.closest('.scroll-wrapper');
                        if (wrapper) {
                            setTimeout(() => {
                                wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
                            }, 500);
                        }
                    }, 1000);
                    return;
                }

                // TEXT MODE BURN
                if (!area.value.trim()) return;

                track('Ashed');
                area.classList.add('transition-all', 'duration-[1.5s]', 'blur-2xl', 'opacity-0', 'scale-90');

                state.burnComplete = true;

                if (state.hapticsEnabled && navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }

                // Explosion
                const editorCard = document.getElementById('editor-card');
                const rect = editorCard.getBoundingClientRect();
                for (let i = 0; i < 150; i++) {
                    state.particles.push(createParticle(rect.left + rect.width / 2 + (Math.random() - 0.5) * rect.width, rect.bottom));
                }

                if (!state.particleLoopActive) {
                    renderParticles();
                }

                setTimeout(() => {
                    resetMode('burn');
                    const mkt = document.getElementById('burn-marketing');
                    mkt.classList.remove('hidden');

                    // Hide footer to prevent overscroll and visual clutter
                    const footer = document.getElementById('ash-footer');
                    if (footer) footer.classList.add('hidden');

                    // Sync scroll with fly-in
                    const wrapper = mkt.closest('.scroll-wrapper');
                    if (wrapper) {
                        setTimeout(() => {
                            wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
                        }, 500);
                    }
                }, 1500);
            }

            // --- AUDIO LOGIC ---
            function toggleMode() {
                const btn = document.getElementById('ui-btn-mode');
                const textArea = document.getElementById('burn-area');
                const audioWrapper = document.getElementById('audio-wrapper');

                // Controls containers
                const fontCtrl = document.getElementById('ctrl-font-container');
                const themeCtrl = document.getElementById('ctrl-theme-container');
                const hapticMobile = document.getElementById('ctrl-haptic-mobile');

                if (state.mode === 'text') {
                    state.mode = 'audio';
                    btn.innerHTML = '<i class="fa-solid fa-align-left"></i><span>Text</span>';

                    // Mode Visibility
                    fontCtrl.classList.add('hidden');
                    themeCtrl.classList.add('hidden');
                    hapticMobile.classList.remove('hidden');
                    hapticMobile.classList.add('flex');

                    // Dynamic adaptation for the toggle button itself
                    const isActualDark = (state.themeColorIndex === 0) ? (state.globalTheme === 'dark') : themeColors[state.themeColorIndex].isCardDark;
                    btn.classList.remove('bg-white/5', 'bg-black/5', 'bg-white/20', 'bg-black/20', 'opacity-40', 'opacity-70');
                    btn.classList.add(isActualDark ? 'bg-white/20' : 'bg-black/20', 'opacity-100');

                    // Update Main Button for Audio
                    document.getElementById('btn-main-action').innerText = "RECORD";

                    textArea.classList.add('opacity-0', 'pointer-events-none');
                    audioWrapper.classList.remove('hidden', 'pointer-events-none');
                    // Small delay to allow display:block to apply before opacity transition
                    setTimeout(() => audioWrapper.classList.remove('opacity-0'), 10);

                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();
                    initAudio();
                } else {
                    state.mode = 'text';
                    btn.innerHTML = '<i class="fa-solid fa-microphone"></i><span>Voice</span>';

                    // Mode Visibility
                    fontCtrl.classList.remove('hidden');
                    themeCtrl.classList.remove('hidden');
                    hapticMobile.classList.add('hidden');
                    hapticMobile.classList.remove('flex');

                    const isActualDark = (state.themeColorIndex === 0) ? (state.globalTheme === 'dark') : themeColors[state.themeColorIndex].isCardDark;
                    btn.classList.remove('bg-white/20', 'bg-black/20', 'opacity-100');
                    btn.classList.add(isActualDark ? 'bg-white/5' : 'bg-black/5', 'opacity-70');

                    // Update Main Button for Text
                    document.getElementById('btn-main-action').innerHTML = `<span>Ash It</span><kbd class="ml-2 opacity-50 text-[11px] border border-white/20 px-1.5 py-0.5 rounded font-medium lowercase pointer-events-none tracking-normal">Ctrl+Enter</kbd>`;

                    audioWrapper.classList.add('opacity-0');
                    setTimeout(() => {
                        audioWrapper.classList.add('hidden', 'pointer-events-none');
                        textArea.classList.remove('opacity-0', 'pointer-events-none');
                    }, 300);

                    stopRecording(); // Safety stop

                    // Reset Button Style/Opacity for Text mode
                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();

                    // Cleanup Audio Resources
                    if (state.source) {
                        state.source.mediaStream.getTracks().forEach(track => track.stop());
                        state.source = null;
                    }
                    if (state.audioContext) {
                        state.audioContext.close();
                        state.audioContext = null;
                    }
                }
            }


            async function initAudio() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    state.analyser = state.audioContext.createAnalyser();
                    state.source = state.audioContext.createMediaStreamSource(stream);
                    state.source.connect(state.analyser);

                    state.analyser.fftSize = 256;
                    drawVisualizer();

                    // MIME Type Detection for Safari/iOS
                    const mimeTypes = [
                        'audio/webm;codecs=opus',
                        'audio/webm',
                        'audio/mp4',
                        'audio/ogg',
                        'audio/wav',
                        'audio/aac'
                    ];
                    let selectedMimeType = '';
                    for (const type of mimeTypes) {
                        if (MediaRecorder.isTypeSupported(type)) {
                            selectedMimeType = type;
                            break;
                        }
                    }

                    if (!selectedMimeType) {
                        console.warn('No standard MIME type supported, letting browser choose default.');
                    } else {
                        console.log('Using MIME type:', selectedMimeType);
                    }

                    const options = selectedMimeType ? { mimeType: selectedMimeType } : {};
                    state.mediaRecorder = new MediaRecorder(stream, options);

                    state.mediaRecorder.ondataavailable = e => {
                        if (e.data && e.data.size > 0) {
                            state.audioChunks.push(e.data);
                        }
                    };

                    state.mediaRecorder.onerror = e => {
                        console.error('MediaRecorder Error:', e);
                        alert('Recording error: ' + e.error.message);
                    };

                    state.mediaRecorder.onstop = () => {
                        const blobType = selectedMimeType || 'audio/webm'; // Fallback
                        state.audioBlob = new Blob(state.audioChunks, { type: blobType });
                        state.audioChunks = [];
                        console.log('Recording stopped. Blob created with type:', blobType, 'Size:', state.audioBlob.size);
                    };
                } catch (err) {
                    console.error('Mic Error:', err);
                    alert('Microphone access needed for Voice Ash. ' + err.message);
                    toggleMode(); // Go back to text
                }
            }

            function toggleRecording() {
                if (!state.mediaRecorder) {
                    alert("Microphone not ready. Please allow access and try again.");
                    // Attempt re-init if stuck?
                    if (state.mode === 'audio') initAudio();
                    return;
                }

                // const recBtnIndicator = document.getElementById('record-indicator'); // REMOVED
                const statusText = document.getElementById('audio-status');
                // const btnRecord = document.getElementById('btn-record'); // REMOVED
                const mainBtn = document.getElementById('btn-main-action');

                if (state.isRecording) {
                    stopRecording();
                } else {
                    // Start
                    state.isRecording = true;
                    // Clear previous blob if any
                    state.audioBlob = null;
                    state.audioChunks = [];
                    document.getElementById('btn-play-audio').classList.add('hidden');
                    // document.getElementById('btn-download-audio').classList.add('hidden');

                    state.mediaRecorder.start();
                    mainBtn.innerText = "STOP"; // Update Main Button
                    mainBtn.classList.add('bg-red-600', 'animate-pulse'); // Add visual cue

                    statusText.innerText = "Recording...";
                    statusText.classList.add('text-nexus-orange', 'animate-pulse');
                    statusText.classList.remove('opacity-40');

                    // Timer
                    state.startTime = Date.now();
                    state.timerInterval = setInterval(updateTimer, 1000);
                }
            }

            function stopRecording() {
                if (!state.isRecording) return;
                state.isRecording = false;
                if (state.mediaRecorder.state !== 'inactive') state.mediaRecorder.stop();

                clearInterval(state.timerInterval);

                state.el.mainBtn.innerText = "ASH IT"; // Update Main Button
                state.el.mainBtn.classList.remove('bg-red-600', 'animate-pulse');

                state.el.status.innerText = "Ready to Burn";
                state.el.status.classList.remove('text-nexus-orange', 'animate-pulse');
                state.el.status.classList.add('opacity-40');

                // Show Play button
                document.getElementById('btn-play-audio').classList.remove('hidden');
                // document.getElementById('btn-download-audio').classList.remove('hidden');
            }

            function updateTimer() {
                const diff = Math.floor((Date.now() - state.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const S = (diff % 60).toString().padStart(2, '0');
                state.el.timer.innerText = `${m}:${S}`;
            }

            function togglePlayback() {
                if (!state.audioBlob) return;

                const btn = document.getElementById('btn-play-audio');
                const icon = btn.querySelector('i');

                // If currently playing, pause it
                if (state.currentAudio && !state.currentAudio.paused) {
                    state.currentAudio.pause();
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    icon.classList.add('translate-x-1');
                    return;
                }

                // If paused or new, play it
                if (!state.currentAudio) {
                    state.currentAudio = new Audio(URL.createObjectURL(state.audioBlob));
                    state.currentAudio.onended = () => {
                        icon.classList.remove('fa-pause');
                        icon.classList.add('fa-play');
                        icon.classList.add('translate-x-1');
                        state.currentAudio = null;
                    };
                }

                state.currentAudio.play()
                    .then(() => {
                        icon.classList.remove('fa-play');
                        icon.classList.remove('translate-x-1');
                        icon.classList.add('fa-pause');
                    })
                    .catch(e => {
                        console.error("Playback failed:", e);
                        alert("Playback failed: " + e.message);
                    });
            }
            window.togglePlayback = togglePlayback;

            function resetAudioState() {
                // Stop playback if active
                if (state.currentAudio) {
                    state.currentAudio.pause();
                    state.currentAudio = null;
                }
                const btn = document.getElementById('btn-play-audio');
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    icon.classList.add('translate-x-1');
                }

                state.audioBlob = null;
                state.isRecording = false;
                clearInterval(state.timerInterval);
                document.getElementById('audio-timer').innerText = "00:00";
                if (state.hapticsEnabled && navigator.vibrate) navigator.vibrate(50);

                // Reset UI
                const audioWrapper = document.getElementById('audio-wrapper');
                const canvas = document.getElementById('audio-visualizer');
                canvas.classList.remove('transition-all', 'duration-[1s]', 'blur-xl', 'scale-150', 'opacity-0');
                document.getElementById('audio-status').innerText = "Tap to Record";
                document.getElementById('btn-play-audio').classList.add('hidden');
                // document.getElementById('btn-download-audio').classList.add('hidden');

                // Reset Main Button Text
                if (state.mode === 'audio') {
                    document.getElementById('btn-main-action').innerText = "RECORD";
                }
            }

            function drawVisualizer() {
                if (state.mode !== 'audio' || !state.analyser) {
                    cancelAnimationFrame(state.visualizerId);
                    return;
                }

                const canvas = state.el.visualizer;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                const bufferLength = state.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                state.analyser.getByteFrequencyData(dataArray);

                ctx.clearRect(0, 0, width, height);

                const barWidth = 2.5; // Fine bars
                const gap = 3;
                const barCount = Math.floor(width / (barWidth + gap));

                const isActualDark = (state.themeColorIndex === 0) ? (state.globalTheme === 'dark') : themeColors[state.themeColorIndex].isCardDark;
                const isActive = state.isRecording;

                // Move fillStyle and path initiation out of loop for performance
                if (isActive) {
                    ctx.fillStyle = 'rgba(255, 69, 0, 0.8)';
                } else if (isActualDark) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                } else {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                }

                ctx.beginPath();
                const radius = barWidth / 2;

                for (let i = 0; i < barCount; i++) {
                    const percent = i / barCount;
                    const freqIdx = Math.floor(Math.pow(percent, 0.75) * (bufferLength * 0.7));
                    const value = dataArray[freqIdx];

                    let barHeight = (value / 255) * height * 1.5;
                    if (barHeight < 6) barHeight = 6;
                    if (barHeight > height) barHeight = height;

                    const x = i * (barWidth + gap);
                    const y = (height - barHeight) / 2;

                    if (ctx.roundRect) {
                        ctx.roundRect(x, y, barWidth, barHeight, radius);
                    } else {
                        ctx.rect(x, y, barWidth, barHeight);
                    }
                }
                ctx.fill();

                state.visualizerId = requestAnimationFrame(drawVisualizer);
            }

            function resetMode(mode) {
                if (mode === 'burn') {
                    state.burnComplete = false;
                    state.el.area.value = '';

                    // Reset Button Style & Text
                    if (state.mode === 'text') {
                        state.el.mainBtn.innerHTML = `<span>Ash It</span> <kbd class="ml-2 opacity-50 text-[11px] border border-white/20 px-1.5 py-0.5 rounded font-medium lowercase pointer-events-none tracking-normal">Ctrl+Enter</kbd>`;
                    } else {
                        state.el.mainBtn.innerText = "RECORD";
                    }
                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();

                    // Reset Audio
                    if (state.mode === 'audio') {
                        resetAudioState();
                    }

                    // Remove animation classes
                    state.el.area.classList.remove('transition-all', 'duration-[1.5s]', 'blur-2xl', 'opacity-0', 'scale-90');

                    // Re-apply current settings to ensure consistency
                    changeTextSize(state.textSizeIndex);
                    changeThemeColor(state.themeColorIndex);
                    document.getElementById('burn-action').classList.remove('hidden');
                    document.getElementById('burn-action').style.opacity = '1';
                    document.getElementById('burn-marketing').classList.add('hidden');
                    const footer = document.getElementById('ash-footer');
                    if (footer) footer.classList.remove('hidden');
                    if (window.updateMainButtonOpacity) window.updateMainButtonOpacity();
                }
                if (mode === 'smash') {
                    state.hits = 0;
                    document.querySelectorAll('.crack-layer').forEach(c => c.remove());
                    document.getElementById('smash-marketing').classList.add('hidden');
                    document.getElementById('smash-hint').innerText = "Tap repeatedly to release energy";
                }
            }

            // --- SMASH IT ---
            function triggerHammer(e) {
                if (state.hits >= 10) return;
                state.hits++;
                track('Smashed');

                // Haptic
                if (navigator.vibrate) navigator.vibrate(50);

                // Audio
                const sound = document.getElementById('crack-sound');
                sound.currentTime = 0;
                sound.play().catch(e => { });

                // Visual
                const crack = document.createElement('img');
                crack.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M10,10 L30,40 L5,60 M30,40 L60,30 L90,10 M60,30 L70,80 L40,90 M70,80 L95,65' stroke='white' fill='none' stroke-width='0.5'/%3E%3C/svg%3E";
                crack.className = 'crack-layer w-40';
                crack.style.left = `${e.clientX - 80}px`;
                crack.style.top = `${e.clientY - 80}px`;
                crack.style.transform = `rotate(${Math.random() * 360}deg) scale(${0.8 + Math.random()})`;
                document.getElementById('view-smash').appendChild(crack);

                document.getElementById('smash-hint').innerText = `${state.hits} / 10`;

                if (state.hits >= 10) {
                    setTimeout(() => {
                        document.getElementById('smash-marketing').classList.remove('hidden');
                    }, 400);
                }
            }

            // --- CAlM IT ---
            function adjustCalmTime(delta) {
                state.calmBaseTime = Math.max(3, Math.min(10, state.calmBaseTime + delta));
                document.getElementById('calm-time-display').innerText = state.calmBaseTime;
                updateCalmStyles();
                if (state.interval) {
                    clearInterval(state.timerInterval);
                    runCalmLoop();
                }
            }
            window.adjustCalmTime = adjustCalmTime;

            function updateCalmStyles() {
                const base = state.calmBaseTime;
                const exhale = base + 2;
                const rest = 2; // 2s Break
                const total = (base * 2) + exhale + rest;

                // Percentages for keyframes
                const p1 = ((base / total) * 100).toFixed(1);
                const p2 = (((base * 2) / total) * 100).toFixed(1);
                const p3 = (((base * 2 + exhale) / total) * 100).toFixed(1);

                let calmStyle = document.getElementById('dynamic-calm-style');
                if (!calmStyle) {
                    calmStyle = document.createElement('style');
                    calmStyle.id = 'dynamic-calm-style';
                    document.head.appendChild(calmStyle);
                }

                calmStyle.innerHTML = `
                    :root { --calm-duration: ${total}s; }
                    @keyframes circle-breathe {
                        0% { transform: scale(1); opacity: 0.2; }
                        ${p1}% { transform: scale(1.6); opacity: 0.7; }
                        ${p2}% { transform: scale(1.6); opacity: 0.7; }
                        ${p3}% { transform: scale(1); opacity: 0.2; }
                        100% { transform: scale(1); opacity: 0.2; }
                    }
                `;
            }

            function runCalmLoop() {
                const txt = document.getElementById('breathing-txt');
                const countdownEl = document.getElementById('calm-timer-countdown');
                const base = state.calmBaseTime;
                const exhale = base + 2;
                const rest = 2;

                if (state.interval) {
                    clearTimeout(state.interval);
                    clearInterval(state.timerInterval);
                    state.interval = null;
                }

                function nextPhase(phase) {
                    const phases = [
                        { text: "Inhale", duration: base },
                        { text: "Hold", duration: base },
                        { text: "Exhale", duration: exhale },
                        { text: "Rest", duration: rest }
                    ];

                    const current = phases[phase];
                    txt.innerText = current.text;
                    let timeLeft = current.duration;

                    countdownEl.innerText = timeLeft;

                    // Per-second tick
                    if (state.timerInterval) clearInterval(state.timerInterval);
                    state.timerInterval = setInterval(() => {
                        timeLeft--;
                        if (timeLeft > 0) {
                            countdownEl.innerText = timeLeft;
                        } else {
                            clearInterval(state.timerInterval);
                        }
                    }, 1000);

                    state.interval = setTimeout(() => {
                        nextPhase((phase + 1) % 4);
                    }, current.duration * 1000);
                }

                nextPhase(0);
                updateCalmStyles();
                track('Calmed');
            }

            function finishCalm() {
                if (state.interval) {
                    clearTimeout(state.interval);
                    clearInterval(state.timerInterval);
                    state.interval = null;
                }
                document.getElementById('calm-marketing').classList.remove('hidden');
            }

            // --- MODAL & SHARE ---
            function toggleWaitlist(show) {
                const modal = document.getElementById('waitlist-modal');
                modal.classList.toggle('hidden', !show);
                if (show) track('Waitlist Overlay Viewed');
            }

            async function shareLink() {
                try {
                    await navigator.share({
                        title: 'Nexus',
                        text: 'Into the void.',
                        url: window.location.href
                    });
                } catch (e) { }
            }

            function submitInlineWaitlist() {
                const input = document.getElementById('waitlist-email-inline');
                const email = input.value.trim();
                if (!email || !email.includes('@')) {
                    input.classList.add('border-red-500/50');
                    setTimeout(() => input.classList.remove('border-red-500/50'), 2000);
                    return;
                }

                track(`Inline Waitlist Join: ${email}`);

                // Show Success State
                const container = input.parentElement;
                container.innerHTML = `
                    <div class="w-full py-2 text-nexus-orange font-black uppercase tracking-[0.2em] text-[10px] animate-fade">
                        <i class="fa-solid fa-check mr-2"></i> You're on the list
                    </div>
                `;
            }

            window.submitInlineWaitlist = submitInlineWaitlist;

            // --- PWA ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js').then(reg => {
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available, sw.js skipWaiting() will trigger controllerchange
                                    console.log('New update available.');
                                }
                            };
                        };
                    }).catch(e => console.log('SW Fail'));
                });

                // Reload when new worker takes over
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        window.location.reload();
                        refreshing = true;
                    }
                });
            }

            // Resize handler
            window.addEventListener('resize', setupCanvas);

            // Close controls when clicking elsewhere
            window.addEventListener('click', (e) => {
                if (!e.target.closest('#ctrl-font-container') && !e.target.closest('#ctrl-theme-container')) {
                    toggleControl(null);
                }
            });


            // --- EDITOR CONTROLS ---
            function toggleControl(id) {
                const fontControl = document.getElementById('ctrl-font');
                const themeControl = document.getElementById('ctrl-theme');

                if (id === null) {
                    fontControl.classList.remove('w-32');
                    fontControl.classList.add('w-0');
                    themeControl.classList.remove('w-32', 'pl-4');
                    themeControl.classList.add('w-0');
                    return;
                }

                const el = document.getElementById(id);
                // Close others
                if (id === 'ctrl-font') {
                    themeControl.classList.remove('w-32', 'pl-4');
                    themeControl.classList.add('w-0');
                } else {
                    fontControl.classList.remove('w-32');
                    fontControl.classList.add('w-0');
                }

                // Toggle current
                if (id === 'ctrl-font') {
                    if (el.classList.contains('w-0')) {
                        el.classList.remove('w-0');
                        el.classList.add('w-32');
                    } else {
                        el.classList.add('w-0');
                        el.classList.remove('w-32');
                    }
                } else { // Theme
                    if (el.classList.contains('w-0')) {
                        el.classList.remove('w-0');
                        el.classList.add('w-32', 'pl-4');
                    } else {
                        el.classList.add('w-0');
                        el.classList.remove('w-32', 'pl-4');
                    }
                }
            }

            function toggleHaptics() {
                state.hapticsEnabled = !state.hapticsEnabled;
                const btn = document.getElementById('ui-btn-haptic');
                if (state.hapticsEnabled) {
                    btn.classList.add('opacity-100');
                    btn.classList.remove('opacity-40');
                    if (navigator.vibrate) navigator.vibrate(50);
                } else {
                    btn.classList.remove('opacity-100');
                    btn.classList.add('opacity-40');
                }
                track(`Haptics Toggled: ${state.hapticsEnabled}`);
            }
            window.toggleHaptics = toggleHaptics;

            function changeTextSize(val) {
                // If val is provided, use it (slider). Otherwise cycle (button fallback, though button is removed)
                const area = document.getElementById('burn-area');

                // Remove current size class
                area.classList.remove(...textSizes[state.textSizeIndex].class.split(' '));

                if (val !== undefined) {
                    state.textSizeIndex = parseInt(val);
                } else {
                    // Cycle index (fallback)
                    state.textSizeIndex = (state.textSizeIndex + 1) % textSizes.length;
                }

                // Add new size class
                area.classList.add(...textSizes[state.textSizeIndex].class.split(' '));
                track(`Theme Color Changed`);
            }

            function changeThemeColor(index) {
                const view = document.getElementById('view-burn');
                const card = document.getElementById('editor-card');
                const area = document.getElementById('burn-area');

                // Remove current classes
                view.classList.remove(themeColors[state.themeColorIndex].bgClass);
                card.classList.remove(themeColors[state.themeColorIndex].cardBg);
                area.classList.remove(themeColors[state.themeColorIndex].textClass);

                // Card no longer has theme bg directly (it's glass now)

                // Set new index
                if (index !== undefined) {
                    state.themeColorIndex = index;
                } else {
                    state.themeColorIndex = (state.themeColorIndex + 1) % themeColors.length;
                }

                // Add new classes
                view.classList.add(themeColors[state.themeColorIndex].bgClass);
                card.classList.add(themeColors[state.themeColorIndex].cardBg);
                area.classList.add(themeColors[state.themeColorIndex].textClass);

                // Update CSS Variable for dot pattern and shadow
                view.style.setProperty('--dot-color', themeColors[state.themeColorIndex].dotColor);
                card.style.setProperty('--shadow-color', themeColors[state.themeColorIndex].shadowColor);

                // --- DYNAMIC UI UPDATES ---
                const t = themeColors[state.themeColorIndex];

                // Determine if the theme's background is ACTUALLY dark right now
                let isActualDark = t.isCardDark;
                if (state.themeColorIndex === 0) { // Void theme
                    isActualDark = (state.globalTheme === 'dark');
                } else if (state.themeColorIndex === 4) { // Midnight theme
                    isActualDark = true;
                }

                // Adaptive properties based on actual darkness
                const activeUiBg = isActualDark ? 'bg-white/5' : 'bg-black/5';
                const activeUiBorder = isActualDark ? 'border-white/5' : 'border-black/5';
                const activeHover = isActualDark ? 'hover:bg-white/10' : 'hover:bg-black/10';
                const activeTextMain = isActualDark ? 'text-white' : 'text-black';
                const activeTextDim = isActualDark ? 'text-white/50' : 'text-black/50';
                const activeHoverIcon = isActualDark ? 'hover:text-white/80' : 'hover:text-black/80';

                const uiNodes = [
                    document.getElementById('ui-btn-back'),
                    document.getElementById('ui-btn-tune'),
                    document.getElementById('ctrl-font-container'),
                    document.getElementById('ctrl-theme-container')
                ];

                const iconNodes = [
                    document.getElementById('ui-icon-font'),
                    document.getElementById('ui-icon-theme')
                ];

                const textNodes = [
                    document.getElementById('ui-text-project'),
                    ...document.querySelectorAll('#view-burn h1, #view-burn h1 span, #view-burn p')
                ];

                const dimNodes = [
                    document.getElementById('ui-text-release'),
                    document.getElementById('ui-text-footer'),
                    document.getElementById('audio-status')
                ];

                const accentNodes = [
                    document.getElementById('audio-timer')
                ];

                // 1. Buttons & Containers
                uiNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('bg-white/5', 'bg-black/5', 'border-white/5', 'border-black/5', 'text-white', 'text-black', 'hover:bg-white/10', 'hover:bg-black/10', 'bg-text-light/5', 'border-text-light/5');
                    el.classList.add(activeUiBg, activeUiBorder, activeHover);
                });

                // 2. Control Icons
                iconNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white/50', 'text-black/50', 'hover:text-white/80', 'hover:text-black/80');
                    el.classList.add(activeTextDim, activeHoverIcon);
                });

                // 3. Main UI Text
                textNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white', 'text-black', 'text-text-light');
                    el.classList.add(activeTextMain);
                    // Force high contrast for headings and paragraphs
                    if (el.tagName === 'H1' || el.tagName === 'P' || el.tagName === 'SPAN') {
                        el.style.color = isActualDark ? 'rgba(255,255,255,0.95)' : 'rgba(0,0,0,0.95)';
                        // Handle shiny tagline gradient override
                        if (el.id === 'shiny-tagline-burn') {
                            if (isActualDark) {
                                el.style.background = `linear-gradient(-35deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.95) 40%, var(--nexus-orange) 50%, rgba(255,255,255,0.95) 60%, rgba(255,255,255,0.95) 100%)`;
                            } else {
                                el.style.background = `linear-gradient(-35deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.95) 40%, var(--nexus-orange) 50%, rgba(0,0,0,0.95) 60%, rgba(0,0,0,0.95) 100%)`;
                            }
                            el.style.backgroundSize = '400% auto';
                            el.style.webkitBackgroundClip = 'text';
                            el.style.backgroundClip = 'text';
                        }
                    }
                });

                // 4. Dim UI Text
                dimNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white/50', 'text-black/50', 'text-text-light/50');
                    el.classList.add(activeTextDim);
                });

                // 5. Accent UI Text (Timer)
                accentNodes.forEach(el => {
                    if (!el) return;
                    el.classList.remove('text-white', 'text-black', 'text-text-light', 'text-white/50', 'text-black/50');
                    el.classList.add(activeTextMain);
                    // Slight dim for timer but still high contrast
                    el.style.opacity = '0.8';
                });

                // 5. Placeholder & Selection Dynamic Style
                let styleEl = document.getElementById('dynamic-theme-style');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'dynamic-theme-style';
                    document.head.appendChild(styleEl);
                }

                // If theme index is 0 (Void), placeholder darkness follows global theme
                const isDark = isActualDark;
                const phColor = isDark ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.1)';
                const phStroke = isDark ? '1px rgba(255, 255, 255, 0.3)' : '1px rgba(0, 0, 0, 0.5)';
                const selectionBg = isDark ? 'rgba(255, 69, 0, 0.3)' : 'rgba(255, 69, 0, 0.2)';
                const shinyBase = '#fff';

                styleEl.textContent = `
                    #burn-area::placeholder {
                        color: ${phColor};
                        opacity: 0.8;
                        font-weight: 300;
                    }
                    ::selection {
                        background: ${selectionBg};
                    }
                    .active-theme-ring {
                        box-shadow: 0 0 0 2px var(--nexus-orange);
                        transform: scale(1.2);
                    }
                `;

                // 6. Highlight active theme button
                const themeContainer = document.getElementById('ctrl-theme');
                if (themeContainer) {
                    themeContainer.querySelectorAll('button').forEach((btn, idx) => {
                        if (idx === state.themeColorIndex) {
                            btn.classList.add('active-theme-ring');
                        } else {
                            btn.classList.remove('active-theme-ring');
                        }
                    });
                }

                // 7. Adaptive colors for Mode Toggles
                const modeToggles = [
                    document.getElementById('ui-btn-mode'),
                    document.getElementById('ui-btn-haptic')
                ];
                modeToggles.forEach(btn => {
                    if (!btn) return;
                    // Force high contrast: 85% opacity text and 25% opacity border
                    btn.style.color = isActualDark ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.85)';
                    btn.classList.remove('border-white/5', 'border-black/5', 'border-white/20', 'border-black/20');
                    btn.style.borderColor = isActualDark ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.25)';
                });

                // Style Audio Play Control - Standard Grey
                const playBtn = document.getElementById('btn-play-audio');
                if (playBtn) {
                    playBtn.style.backgroundColor = isActualDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                    playBtn.style.borderColor = isActualDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)';
                    const playIcon = playBtn.querySelector('i');
                    if (playIcon) {
                        playIcon.style.color = isActualDark ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.85)';
                    }
                }

                track(`Theme Color Changed`);
            }

            // Export to window for HTML onclicks
            window.navigate = navigate;
            window.performBurn = performBurn;
            window.resetMode = resetMode;
            window.triggerHammer = triggerHammer;
            window.toggleMode = toggleMode;
            window.toggleRecording = toggleRecording;
            window.finishCalm = finishCalm;
            window.toggleWaitlist = toggleWaitlist;
            window.shareLink = shareLink;
            window.changeTextSize = changeTextSize;
            window.changeThemeColor = changeThemeColor;
            window.toggleControl = toggleControl;

            function toggleGlobalTheme() {
                state.globalTheme = state.globalTheme === 'dark' ? 'light' : 'dark';
                applyGlobalTheme();
                localStorage.setItem('release-theme', state.globalTheme);
                track(`Global Theme Toggled: ${state.globalTheme}`);
            }
            window.toggleGlobalTheme = toggleGlobalTheme;

            function applyGlobalTheme() {
                const body = document.body;
                const icon = document.getElementById('theme-icon');
                if (state.globalTheme === 'light') {
                    body.classList.add('light-theme');
                    if (icon) {
                        icon.classList.remove('fa-moon');
                        icon.classList.add('fa-sun');
                    }
                } else {
                    body.classList.remove('light-theme');
                    if (icon) {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                    }
                }
                const themeColor = state.globalTheme === 'light' ? '#f8f9fa' : '#050505';
                const metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) metaTheme.setAttribute('content', themeColor);

                // Refresh Ash page theme if it exists
                if (typeof changeThemeColor === 'function') changeThemeColor(state.themeColorIndex);
            }
            window.applyGlobalTheme = applyGlobalTheme;

            function setMainButtonStyle(style) {
                const btn = document.getElementById('btn-main-action');
                if (!btn) return;
                if (style === 'secondary') {
                    btn.classList.add('glass-card', 'text-text-light/30');
                    btn.classList.remove('bg-nexus-orange', 'text-white', 'shadow-[0_0_30px_rgba(255,68,0,0.3)]', 'hover:shadow-[0_0_50px_rgba(255,68,0,0.5)]', 'opacity-50');
                } else {
                    btn.classList.remove('glass-card', 'text-text-light/30', 'opacity-50');
                    btn.classList.add('bg-nexus-orange', 'text-white', 'shadow-[0_0_30px_rgba(255,68,0,0.3)]', 'hover:shadow-[0_0_50px_rgba(255,68,0,0.5)]');
                }
            }
            window.setMainButtonStyle = setMainButtonStyle;

            const area = document.getElementById('burn-area');
            area.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    handleMainAction();
                }
            });

            const mainBtn = document.getElementById('btn-main-action');

            function updateMainButtonOpacity(isHover = false) {
                if (state.mode === 'audio') {
                    setMainButtonStyle('primary');
                    mainBtn.style.opacity = '1';
                    mainBtn.style.pointerEvents = 'auto';
                    mainBtn.disabled = false;
                    return;
                }

                const hasText = area.value.trim().length > 0;

                if (hasText) {
                    setMainButtonStyle('primary');
                    mainBtn.style.pointerEvents = 'auto';
                    mainBtn.disabled = false;
                } else {
                    setMainButtonStyle('secondary');
                    mainBtn.style.pointerEvents = 'none';
                    mainBtn.disabled = true;
                }
            }

            area.addEventListener('input', () => updateMainButtonOpacity());
            mainBtn.addEventListener('mouseenter', () => updateMainButtonOpacity(true));
            mainBtn.addEventListener('mouseleave', () => updateMainButtonOpacity(false));

            // Initialize Opacity
            updateMainButtonOpacity();
            window.updateMainButtonOpacity = updateMainButtonOpacity;

            // Initialize Theme
            applyGlobalTheme();
            changeThemeColor(state.themeColorIndex);
        });
    </script>
    <script src="js/liquid-bg.js"></script>
</body>

</html>